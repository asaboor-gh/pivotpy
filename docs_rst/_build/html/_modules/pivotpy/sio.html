

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pivotpy.sio &mdash; pivotpy 0.9.9 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> pivotpy
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Pivotpy API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pivotpy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pivotpy.sio</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pivotpy.sio</h1><div class="highlight"><pre>
<span></span><span class="c1"># AUTOGENERATED! DO NOT EDIT! File to edit: StructureIO.ipynb (unless otherwise specified).</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;save_mp_API&#39;</span><span class="p">,</span> <span class="s1">&#39;load_mp_data&#39;</span><span class="p">,</span> <span class="s1">&#39;get_crystal&#39;</span><span class="p">,</span> <span class="s1">&#39;get_poscar&#39;</span><span class="p">,</span> <span class="s1">&#39;get_kpath&#39;</span><span class="p">,</span> <span class="s1">&#39;get_kmesh&#39;</span><span class="p">,</span> <span class="s1">&#39;intersect_3p_p_3v&#39;</span><span class="p">,</span>
           <span class="s1">&#39;centroid&#39;</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;in_vol_sector&#39;</span><span class="p">,</span> <span class="s1">&#39;out_bz_plane&#39;</span><span class="p">,</span> <span class="s1">&#39;to_xy&#39;</span><span class="p">,</span> <span class="s1">&#39;rad_angle&#39;</span><span class="p">,</span> <span class="s1">&#39;arctan_full&#39;</span><span class="p">,</span> <span class="s1">&#39;get_bz&#39;</span><span class="p">,</span>
           <span class="s1">&#39;plot_bz&#39;</span><span class="p">]</span>

<span class="c1"># Cell</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">requests</span> <span class="k">as</span> <span class="nn">req</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">permutations</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>

<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">ConvexHull</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">Voronoi</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>

<span class="kn">import</span> <span class="nn">pivotpy.vr_parser</span> <span class="k">as</span> <span class="nn">vp</span>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="save_mp_API"><a class="viewcode-back" href="../../api.html#pivotpy.sio.save_mp_API">[docs]</a><span class="k">def</span> <span class="nf">save_mp_API</span><span class="p">(</span><span class="n">api_key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Save materials project api key for autoload in functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">home</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">())</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span><span class="s1">&#39;.pivotpyrc&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">fr</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="s1">&#39;MP_API_KEY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
        <span class="n">fr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
        <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MP_API_KEY = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api_key</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">fw</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">load_mp_data</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span><span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mp_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_sites</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns fetched data using request api of python form materials project website.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - formula  : Material formula such as &#39;NaCl&#39;.</span>
<span class="sd">        - api_key  : API key for your account from material project site. Auto picks if you already used `save_mp_API` function.</span>
<span class="sd">        - mp_id    : Optional, you can specify material ID to filter results.</span>
<span class="sd">        -max_sites : Option, you can set maximum number of sites to load fastly as it will not fetch all large data sets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">home</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">())</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span><span class="s1">&#39;.pivotpyrc&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;MP_API_KEY&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">api_key</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;api_key not given. provide in argument or generate in file using `save_mp_API(your_mp_api_key)&quot;</span><span class="p">)</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://www.materialsproject.org/rest/v2/materials/_____/vasp?API_KEY=|||||&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_____&#39;</span><span class="p">,</span><span class="n">formula</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|||||&#39;</span><span class="p">,</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
    <span class="n">jl</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">all_res</span> <span class="o">=</span> <span class="n">jl</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">max_sites</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sel_res</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">all_res</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;nsites&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_sites</span><span class="p">:</span>
                <span class="n">sel_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sel_res</span>
    <span class="c1"># Filter to mp_id at last. more preferred</span>
    <span class="k">if</span> <span class="n">mp_id</span> <span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">all_res</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mp_id</span> <span class="o">==</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;material_id&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">all_res</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">get_crystal</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span><span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mp_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_sites</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns crystal information dictionary including cif data format.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - formula  : Material formula such as &#39;NaCl&#39;.</span>
<span class="sd">        - api_key  : API key for your account from material project site. Auto picks if you already used `save_mp_API` function.</span>
<span class="sd">        - mp_id    : Optional, you can specify material ID to filter results.</span>
<span class="sd">        -max_sites : Option, you can set maximum number of sites to load fastly as it will not fetch all large data sets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_res</span> <span class="o">=</span> <span class="n">load_mp_data</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">mp_id</span> <span class="o">=</span> <span class="n">mp_id</span><span class="p">,</span> <span class="n">max_sites</span> <span class="o">=</span> <span class="n">max_sites</span><span class="p">)</span>
    <span class="n">cifs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">all_res</span><span class="p">:</span>
        <span class="n">cif</span>     <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;cif&#39;</span><span class="p">]</span>
        <span class="n">symbol</span>  <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;spacegroup&#39;</span><span class="p">][</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span>
        <span class="n">crystal</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;spacegroup&#39;</span><span class="p">][</span><span class="s1">&#39;crystal_system&#39;</span><span class="p">]</span>
        <span class="n">unit</span>    <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;unit_cell_formula&#39;</span><span class="p">]</span>
        <span class="n">mp_id</span>   <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;material_id&#39;</span><span class="p">]</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mp_id</span> <span class="o">=</span> <span class="n">mp_id</span><span class="p">,</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">crystal</span> <span class="o">=</span> <span class="n">crystal</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span><span class="p">,</span> <span class="n">cif</span> <span class="o">=</span> <span class="n">cif</span><span class="p">)</span>
        <span class="n">cifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vp</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">(</span><span class="n">crs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cifs</span>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="get_poscar"><a class="viewcode-back" href="../../api.html#pivotpy.sio.get_poscar">[docs]</a><span class="k">def</span> <span class="nf">get_poscar</span><span class="p">(</span><span class="n">formula</span> <span class="p">,</span><span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mp_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_sites</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns poscar information dictionary including cif data format.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - formula  : Material formula such as &#39;NaCl&#39;.</span>
<span class="sd">        - api_key  : API key for your account from material project site. Auto picks if you already used `save_mp_API` function.</span>
<span class="sd">        - mp_id    : Optional, you can specify material ID to filter results.</span>
<span class="sd">        -max_sites : Option, you can set maximum number of sites to load fastly as it will not fetch all large data sets.</span>
<span class="sd">    - **Usage**</span>
<span class="sd">        - `get_poscar(&#39;GaAs&#39;,api_key,**kwargs)`. Same result is returned from `Get-POSCAR` command in PowerShell terminal if Vasp2Visual module is installed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">crys</span> <span class="o">=</span> <span class="n">get_crystal</span><span class="p">(</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="p">,</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">mp_id</span> <span class="o">=</span> <span class="n">mp_id</span><span class="p">,</span> <span class="n">max_sites</span> <span class="o">=</span> <span class="n">max_sites</span><span class="p">)</span>
    <span class="n">poscars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cr</span> <span class="ow">in</span> <span class="n">crys</span><span class="p">:</span>
        <span class="n">cif</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">cif</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">cif</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">abc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">abc_ang</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;_cell&#39;</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;_length&#39;</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">:</span>
                    <span class="n">abc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ys</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;_angle&#39;</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">:</span>
                    <span class="n">abc_ang</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ys</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;_volume&#39;</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">:</span>
                    <span class="n">volume</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ys</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;_structural&#39;</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">:</span>
                <span class="n">system</span> <span class="o">=</span> <span class="n">ys</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;_atom_site_occupancy&#39;</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span><span class="mi">1</span> <span class="c1"># start collecting pos.</span>
        <span class="n">poses</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
        <span class="n">pos_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">poses</span><span class="p">:</span>
            <span class="n">s_p</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">pos_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{0:&gt;12}</span><span class="s2">  </span><span class="si">{1:&gt;12}</span><span class="s2">  </span><span class="si">{2:&gt;12}</span><span class="s2">  </span><span class="si">{3}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">s_p</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span><span class="n">s_p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># ======== Cleaning ===========</span>
        <span class="n">abc_ang</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span> <span class="k">for</span> <span class="n">ang</span> <span class="ow">in</span> <span class="n">abc_ang</span><span class="p">]</span>
        <span class="n">abc</span>     <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">abc</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&gt;22.16f}</span><span class="s2"> </span><span class="si">{1:&gt;22.16f}</span><span class="s2"> </span><span class="si">{2:&gt;22.16f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="c1"># lattic vector a.</span>
        <span class="n">to_rad</span> <span class="o">=</span> <span class="mf">0.017453292519</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">abc_ang</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">to_rad</span>
        <span class="n">bx</span><span class="p">,</span><span class="n">by</span> <span class="o">=</span> <span class="n">abc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span><span class="n">abc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&gt;22.16f}</span><span class="s2"> </span><span class="si">{1:&gt;22.16f}</span><span class="s2"> </span><span class="si">{2:&gt;22.16f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bx</span><span class="o">/</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">by</span><span class="o">/</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.0</span><span class="p">)</span> <span class="c1"># lattic vector b.</span>
        <span class="n">cz</span> <span class="o">=</span> <span class="n">volume</span><span class="o">/</span><span class="p">(</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">by</span><span class="p">)</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">abc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">abc_ang</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">to_rad</span><span class="p">)</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">abc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">abc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">abc_ang</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">to_rad</span><span class="p">)</span><span class="o">-</span><span class="n">bx</span><span class="o">*</span><span class="n">cx</span><span class="p">)</span><span class="o">/</span><span class="n">by</span>
        <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&gt;22.16f}</span><span class="s2"> </span><span class="si">{1:&gt;22.16f}</span><span class="s2"> </span><span class="si">{2:&gt;22.16f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cx</span><span class="o">/</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cy</span><span class="o">/</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cz</span><span class="o">/</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># lattic vector b.</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">unit</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
        <span class="n">nums</span>  <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">unit</span><span class="p">[</span><span class="n">elem</span><span class="p">]))</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">unit</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">nums</span>  <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
        <span class="c1"># Get others important info</span>
        <span class="n">symbol</span>  <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">symbol</span>
        <span class="n">crystal</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">crystal</span>
        <span class="n">mp_id</span>   <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">mp_id</span>
        <span class="c1"># ======================</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">system</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"># [</span><span class="si">{0}</span><span class="s2">] Generated by PivotPy using Materials Project Database.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">poscar</span><span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">  </span><span class="si">{1}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{2}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{3}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{4}</span><span class="se">\n</span><span class="s2">  </span><span class="si">{5}</span><span class="se">\n</span><span class="s2">  </span><span class="si">{6}</span><span class="se">\n</span><span class="s2">Direct</span><span class="se">\n</span><span class="si">{7}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top</span><span class="p">,</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">elems</span><span class="p">,</span><span class="n">nums</span><span class="p">,</span><span class="n">pos_str</span><span class="p">)</span>
        <span class="c1"># =======================</span>
        <span class="n">net_out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">system</span> <span class="o">=</span> <span class="n">system</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">crystal</span> <span class="o">=</span><span class="n">crystal</span><span class="p">,</span><span class="n">mp_id</span> <span class="o">=</span> <span class="n">mp_id</span><span class="p">,</span><span class="n">poscar</span> <span class="o">=</span> <span class="n">poscar</span><span class="p">)</span>
        <span class="n">poscars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vp</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">(</span><span class="n">net_out</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">poscars</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="get_kpath"><a class="viewcode-back" href="../../api.html#pivotpy.sio.get_kpath">[docs]</a><span class="k">def</span> <span class="nf">get_kpath</span><span class="p">(</span><span class="n">hsk_list</span><span class="o">=</span><span class="p">[],</span><span class="n">labels</span><span class="o">=</span><span class="p">[],</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span> <span class="kc">None</span> <span class="p">,</span><span class="n">ibzkpt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Generate list of kpoints along high symmetry path. Options are write to file or return KPOINTS list. It generates uniformly spaced point with input `n` as just a scale factor of number of points per unit length. You can also specify custom number of kpoints in an interval by putting number of kpoints as 4th entry in left kpoint.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - hsk_list : N x 3 list of N high symmetry points, if broken path then [[N x 3],[M x 3],...]. Optionally you can put a 4 values point where 4th entry will decide number of kpoints in current interval. Make sure that points in a connected path patch are at least two i.e. `[[x1,y1,z1],[x2,y2,z2]]` or `[[x1,y1,z1,N],[x2,y2,z2]]`.</span>
<span class="sd">        - n        ; int, number per unit length, this makes uniform steps based on distance between points.</span>
<span class="sd">        - weight : Float, if None, auto generates weights.</span>
<span class="sd">        - gamma  : If True, shifts mesh at gamma point.</span>
<span class="sd">        - ibzkpt : Path to ibzkpt file, required for HSE calculations.</span>
<span class="sd">        - labels : Hight symmetry points labels. Good for keeping record of lables and points indices for later use.                - Note: If you do not want to label a point, label it as &#39;skip&#39; at its index and it will be removed.</span>
<span class="sd">        - outfile: Path/to/file to write kpoints.</span>
<span class="sd">    - **Attributes**</span>
<span class="sd">        - If `outfile = None`, a tuple is returned which consists of:</span>
<span class="sd">            - nkpts   : get_kmesh().nkpts.</span>
<span class="sd">            - kpoints : get_kmesh().kpoints.</span>
<span class="sd">            - weights : get_kmesh().weights.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hsk_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">hsk_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span> <span class="n">hsk_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">hsk_list</span><span class="p">]</span> <span class="c1"># Make overall 3 dimensions to include breaks in path</span>
    <span class="n">xs</span><span class="p">,</span><span class="n">ys</span><span class="p">,</span><span class="n">zs</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span><span class="n">joinat</span> <span class="o">=</span> <span class="p">[],[],[],[</span><span class="mi">0</span><span class="p">],[]</span> <span class="c1"># 0 in inds list is important</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsk_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">_a</span><span class="o">-</span><span class="n">_b</span> <span class="k">for</span> <span class="n">_a</span><span class="p">,</span><span class="n">_b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="mi">3</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">)]</span> <span class="c1"># restruct point if 4 entries</span>
            <span class="n">_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">_vec</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span> <span class="n">_m</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># number of points given explicitly.</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

            <span class="n">inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">_m</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>

                <span class="n">joinat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># Add previous in joinpath</span>
            <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">_m</span><span class="p">)))</span>
            <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">_m</span><span class="p">)))</span>
            <span class="n">zs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">_m</span><span class="p">)))</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">xs</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">z</span><span class="p">]</span> <span class="c1">#flatten values.</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">ys</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">z</span><span class="p">]</span>
    <span class="n">zs</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zs</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">z</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">weight</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{0:&gt;16.10f}{1:&gt;16.10f}{2:&gt;16.10f}{3:&gt;12.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">weight</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span><span class="n">ys</span><span class="p">,</span><span class="n">zs</span><span class="p">)]</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ibzkpt</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ibzkpt</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ibzkpt</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">+</span><span class="n">N</span> <span class="c1"># Update N.</span>
            <span class="n">slines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">N</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">ibz_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slines</span><span class="p">)</span>
            <span class="n">out_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ibz_str</span><span class="p">,</span><span class="n">out_str</span><span class="p">)</span> <span class="c1"># Update out_str</span>
    <span class="k">if</span> <span class="n">inds</span><span class="p">:</span>
        <span class="n">inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># last index to -1</span>
    <span class="c1"># Remove indices and labels where &#39;skip&#39; appears</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span><span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;skip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">if</span> <span class="s1">&#39;skip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
    <span class="n">top_str</span> <span class="o">=</span> <span class="s2">&quot;Automatically generated using PivotPy with HSK-INDS = </span><span class="si">{}</span><span class="s2">, LABELS = </span><span class="si">{}</span><span class="s2">, SEG-INDS = </span><span class="si">{}</span><span class="se">\n\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">Reciprocal Lattice&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">joinat</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top_str</span><span class="p">,</span><span class="n">out_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Mesh&#39;</span><span class="p">,[</span><span class="s1">&#39;nkpts&#39;</span><span class="p">,</span><span class="s1">&#39;kpoints&#39;</span><span class="p">,</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">mesh</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span><span class="n">ys</span><span class="p">,</span><span class="n">zs</span><span class="p">)]),[</span><span class="n">weight</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">])</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="get_kmesh"><a class="viewcode-back" href="../../api.html#pivotpy.sio.get_kmesh">[docs]</a><span class="k">def</span> <span class="nf">get_kmesh</span><span class="p">(</span><span class="n">n_xyz</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span><span class="n">weight</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ibzkpt</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">poscar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Generate uniform mesh of kpoints. Options are write to file, plot or return KPOINTS list.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - n_xyz  : List of [nx ny nz] or integer. If integere given, kmesh is autoscaled.</span>
<span class="sd">        - weight : Float, if None, auto generates weights.</span>
<span class="sd">        - gamma  : Default True, shifts mesh at gamma point.</span>
<span class="sd">        - ibzkpt : Path to ibzkpt file, required for HSE calculations.</span>
<span class="sd">        - poscar : POSCAR file or real space lattice vectors, if None, cubic symmetry is used and it is fast.</span>
<span class="sd">        - outfile: Path/to/file to write kpoints.</span>
<span class="sd">        - plot   : If True, returns interactive plot. You can look at mesh before you start calculation.</span>
<span class="sd">    - **Attributes**</span>
<span class="sd">        - If `plot = False`, a tuple is returned which consists of:</span>
<span class="sd">            - nkpts   : get_kmesh().nkpts.</span>
<span class="sd">            - kpoints : get_kmesh().kpoints.</span>
<span class="sd">            - weight : get_kmesh().weight, its one float number, provided or calculated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">n_xyz</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span> <span class="o">=</span> <span class="n">n_xyz</span><span class="p">,</span><span class="n">n_xyz</span><span class="p">,</span><span class="n">n_xyz</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">n_xyz</span><span class="p">]</span>
    <span class="n">sx</span><span class="p">,</span><span class="n">sy</span><span class="p">,</span><span class="n">sz</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span>
    <span class="k">if</span> <span class="n">poscar</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">BZ</span> <span class="o">=</span> <span class="n">get_bz</span><span class="p">(</span><span class="n">poscar</span><span class="p">)</span>
        <span class="n">vs</span> <span class="o">=</span> <span class="n">BZ</span><span class="o">.</span><span class="n">vertices</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="n">BZ</span><span class="o">.</span><span class="n">basis</span>
        <span class="n">vs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">])</span> <span class="c1"># in b1,b2,b3 space space</span>
        <span class="n">sx</span><span class="p">,</span><span class="n">sy</span><span class="p">,</span><span class="n">sz</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vs</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])]</span>
        <span class="n">nb1</span><span class="p">,</span><span class="n">nb2</span><span class="p">,</span><span class="n">nb3</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sx</span><span class="p">,</span><span class="n">sy</span><span class="p">,</span><span class="n">sz</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">nb1</span><span class="p">,</span><span class="n">nb2</span><span class="p">,</span><span class="n">nb3</span><span class="p">])</span> <span class="o">==</span> <span class="n">nb3</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">n_xyz</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">nz</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span> <span class="n">n_xyz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">nb1</span><span class="o">/</span><span class="n">nb3</span><span class="o">*</span><span class="n">n_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">nb2</span><span class="o">/</span><span class="n">nb3</span><span class="o">*</span><span class="n">n_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">nb1</span><span class="p">,</span><span class="n">nb2</span><span class="p">,</span><span class="n">nb3</span><span class="p">])</span> <span class="o">==</span> <span class="n">nb2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">n_xyz</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nz</span><span class="o">=</span> <span class="n">n_xyz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">nb1</span><span class="o">/</span><span class="n">nb2</span><span class="o">*</span><span class="n">n_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">nb3</span><span class="o">/</span><span class="n">nb2</span><span class="o">*</span><span class="n">n_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">nb1</span><span class="p">,</span><span class="n">nb2</span><span class="p">,</span><span class="n">nb3</span><span class="p">])</span> <span class="o">==</span> <span class="n">nb1</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">n_xyz</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="o">=</span> <span class="n">n_xyz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">nb2</span><span class="o">/</span><span class="n">nb1</span><span class="o">*</span><span class="n">n_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">nb3</span><span class="o">/</span><span class="n">nb1</span><span class="o">*</span><span class="n">n_xyz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># Make center at gamma if True</span>
    <span class="n">tx</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="c1"># Translations in each dirs.</span>
    <span class="k">if</span> <span class="n">gamma</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">tx</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">sx</span><span class="p">,</span><span class="n">sx</span><span class="p">,</span><span class="n">nx</span><span class="p">))),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">sy</span><span class="p">,</span><span class="n">sy</span><span class="p">,</span><span class="n">ny</span><span class="p">))),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">sz</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">nz</span><span class="p">)))]</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">sx</span><span class="o">+</span><span class="n">tx</span><span class="p">,</span><span class="n">sx</span><span class="o">+</span><span class="n">tx</span><span class="p">,</span><span class="n">nx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nx</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">sx</span><span class="o">-</span><span class="n">tx</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">sy</span><span class="o">+</span><span class="n">ty</span><span class="p">,</span><span class="n">sy</span><span class="o">+</span><span class="n">ty</span><span class="p">,</span><span class="n">ny</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ny</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="n">sy</span><span class="o">-</span><span class="n">ty</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">sz</span><span class="o">+</span><span class="n">tz</span><span class="p">,</span><span class="n">sz</span><span class="o">+</span><span class="n">tz</span><span class="p">,</span><span class="n">nz</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nz</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">+</span><span class="n">sz</span><span class="o">-</span><span class="n">tz</span>
                <span class="c1"># Handle BZ when no POSCAR given and grid shifted for gamma = True</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">sx</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">sy</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">sz</span><span class="p">:</span>
                    <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">points</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sel_pts</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># placeholder</span>
    <span class="n">top_info</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">poscar</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bz</span> <span class="o">=</span> <span class="n">get_bz</span><span class="p">(</span><span class="n">poscar</span><span class="p">)</span>
        <span class="n">top_info</span> <span class="o">=</span> <span class="s1">&#39; filtered in 1st BZ of rec_basis = [</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">bz</span><span class="o">.</span><span class="n">basis</span><span class="p">)</span> <span class="c1"># first space is must.</span>
        <span class="n">vs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bz</span><span class="o">.</span><span class="n">vertices</span><span class="p">])</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
            <span class="n">h2</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">([</span><span class="o">*</span><span class="n">vs</span><span class="p">,</span><span class="n">p</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">h2</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="n">h1</span><span class="o">.</span><span class="n">volume</span><span class="p">):</span>
                <span class="n">sel_pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sel_pts</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No KPOINTS in BZ from given input. Try larger input!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weight</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">))</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{0:&gt;16.10f}{1:&gt;16.10f}{2:&gt;16.10f}{3:&gt;12.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">weight</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ibzkpt</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ibzkpt</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ibzkpt</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">+</span><span class="n">N</span> <span class="c1"># Update N.</span>
            <span class="n">slines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">N</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">ibz_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slines</span><span class="p">)</span>
            <span class="n">out_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ibz_str</span><span class="p">,</span><span class="n">out_str</span><span class="p">)</span> <span class="c1"># Update out_str</span>
    <span class="n">top_str</span> <span class="o">=</span> <span class="s2">&quot;Automatically generated uniform mesh using PivotPy with </span><span class="si">{}</span><span class="s2">x</span><span class="si">{}</span><span class="s2">x</span><span class="si">{}</span><span class="s2"> grid</span><span class="si">{}</span><span class="se">\n\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">Reciprocal Lattice&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">top_info</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top_str</span><span class="p">,</span><span class="n">out_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NKPTS: &#39;</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">poscar</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">poscar</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">BZ</span> <span class="o">=</span> <span class="n">get_bz</span><span class="p">(</span><span class="n">poscar</span><span class="p">)</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="n">BZ</span><span class="o">.</span><span class="n">basis</span>
        <span class="n">data</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">bs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">bs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">points</span><span class="p">])</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bs</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;b&lt;sub&gt;</span><span class="si">{}</span><span class="s1">&lt;/sub&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">z</span><span class="o">=</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;KPOINTS&#39;</span><span class="p">,</span><span class="n">marker_size</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">pts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">BZ</span><span class="o">.</span><span class="n">faces</span><span class="p">):</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">z</span><span class="o">=</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span><span class="n">surfaceaxis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;rgba(130,210,110,0.6)&#39;</span><span class="p">,</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;F&lt;sub&gt;</span><span class="si">{}</span><span class="s1">&lt;/sub&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">))</span>
        <span class="n">camera</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">center</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene_camera</span><span class="o">=</span><span class="n">camera</span><span class="p">,</span><span class="n">plot_bgcolor</span><span class="o">=</span><span class="s1">&#39;rgb(255,255,255)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Mesh&#39;</span><span class="p">,[</span><span class="s1">&#39;nkpts&#39;</span><span class="p">,</span><span class="s1">&#39;kpoints&#39;</span><span class="p">,</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">mesh</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">points</span><span class="p">,</span><span class="n">weight</span><span class="p">)</span></div>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">intersect_3p_p_3v</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns intersection point of 3 planes in 3D.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - a,b,c : three vectors in 3D, whose perpendicular planes will be intersected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">out</span>
<span class="k">def</span> <span class="nf">centroid</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns centroid of a list of 3D points.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - points: List[List(len=3)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="n">_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="n">_z</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">_x</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">_len</span>
    <span class="n">_y</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">_len</span>
    <span class="n">_z</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">_z</span><span class="p">)</span> <span class="o">/</span> <span class="n">_len</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span><span class="n">_z</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">center</span>

<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns counterclockwise ordered vertices of a plane in 3D. Append first vertex at end to make loop.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - points: List[List(len=3)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">-</span><span class="n">c</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">center</span><span class="p">)]</span>
    <span class="n">ey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">ex</span><span class="p">)</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="n">ex</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>  <span class="c1"># i</span>
    <span class="n">ey</span> <span class="o">=</span> <span class="n">ey</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ey</span><span class="p">)</span>  <span class="c1"># j</span>
    <span class="n">angles</span><span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">-</span><span class="n">c</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">center</span><span class="p">)]</span>
        <span class="n">vx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">vy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">ey</span><span class="p">)</span>
        <span class="c1">#print(np.sign(vx),np.sign(vy))</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">vy</span><span class="o">/</span><span class="n">vx</span><span class="p">))</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">theta</span> <span class="c1"># start</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">theta</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">theta</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">theta</span>
        <span class="k">if</span> <span class="n">vx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">vx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">vy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">vy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">angle</span><span class="p">])</span>
    <span class="c1">#print(angles)</span>
    <span class="n">s_angs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
    <span class="n">ss</span><span class="o">=</span> <span class="n">s_angs</span><span class="p">[</span><span class="n">s_angs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>
    <span class="c1">#print(ss)</span>
    <span class="n">o_pts</span> <span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ss</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)])</span>
        <span class="n">o_pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
    <span class="n">o_pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">o_pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">o_pts</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">in_vol_sector</span><span class="p">(</span><span class="n">test_point</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns True if test_point lies inside/on the overlapping planes of three vectors.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - p1,p2,p3: Three vectors points in 3D.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_point</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">test_point</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">centroid</span><span class="p">([</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span><span class="p">]))</span>
        <span class="n">_dot_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p_test</span><span class="o">-</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span>  <span class="n">_dot_test</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-5</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">out_bz_plane</span><span class="p">(</span><span class="n">test_point</span><span class="p">,</span><span class="n">plane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns True if test_point is between plane and origin. Could be used to sample BZ mesh in place of ConvexHull.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - test_points: 3D point.</span>
<span class="sd">        - plane      : List of at least three coplanar points.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outside</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">p_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_point</span><span class="p">)</span>
    <span class="n">plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">centroid</span><span class="p">(</span><span class="n">plane</span><span class="p">))</span>
    <span class="n">_dot_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p_test</span><span class="o">-</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_dot_</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-5</span><span class="p">:</span>
        <span class="n">outside</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">outside</span>


<span class="k">def</span> <span class="nf">to_xy</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Rotate a 3D vector v in xy-plane.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - v: Ponit in 3D.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># by default to hold if x and y both zero</span>
    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">y</span>
    <span class="n">Rx</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">d</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">d</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">d</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">d</span><span class="p">]]</span>
    <span class="n">v_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rx</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>  <span class="c1">#v_out = [x,y,0]</span>
    <span class="k">return</span> <span class="n">v_out</span>

<span class="k">def</span> <span class="nf">rad_angle</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns interier angle between two vectors.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - v1,v2 : Two vectors/points in 3D.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">norm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">dot_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">dot_p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">angle</span>

<span class="k">def</span> <span class="nf">arctan_full</span><span class="p">(</span><span class="n">perp</span><span class="p">,</span><span class="n">base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns full angle from x-axis counter clockwise.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - perp: Perpendicular componet of vector including sign.</span>
<span class="sd">        - base: Base compoent of vector including sign.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vy</span> <span class="o">=</span> <span class="n">perp</span>
    <span class="n">vx</span> <span class="o">=</span> <span class="n">base</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Place hodler to handle exceptions</span>
    <span class="k">if</span> <span class="n">vx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">vx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">vy</span><span class="o">/</span><span class="n">vx</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">theta</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">theta</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">theta</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">vy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">vy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">return</span> <span class="n">angle</span>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="get_bz"><a class="viewcode-back" href="../../api.html#pivotpy.sio.get_bz">[docs]</a><span class="k">def</span> <span class="nf">get_bz</span><span class="p">(</span><span class="n">poscar</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">loop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">digits</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Return required information to construct first Brillouin zone in form of tuple (basis, normals, vertices, faces).</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - poscar : POSCAR file or list of 3 vectors in 3D aslist[list,list,list].</span>
<span class="sd">        - loop   : If True, joins the last vertex of a BZ plane to starting vertex in order to complete loop.</span>
<span class="sd">        - digits : int, rounding off decimal places, no effect on intermediate calculations, just for pretty final results</span>
<span class="sd">    - **Attributes**</span>
<span class="sd">        - basis   : get_bz().basis, recprocal lattice basis.</span>
<span class="sd">        - normals : get_bz().normals, all vertors that are perpendicular BZ faces/planes.</span>
<span class="sd">        - vertices: get_bz().vertices, all vertices of BZ, could be input into ConvexHull for constructing 3D BZ.</span>
<span class="sd">        - faces   : get_bz().faces, vertices arranged into faces, could be input to Poly3DCollection of matplotlib for creating BZ from faces&#39; patches.</span>
<span class="sd">        - specials : get_bz().specials, Dictionary of high symmetry KPOINTS with keys as points relative to basis and values are corresponding positions in recirprocal coordinates space.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">poscar</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;./POSCAR&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">poscar</span> <span class="o">=</span> <span class="s1">&#39;./POSCAR&#39;</span>
    <span class="k">elif</span> <span class="n">poscar</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;./POSCAR&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;poscar&#39; expects file &#39;POSCAR&#39; or 3 basis vectors.&quot;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="o">=</span><span class="p">[],[],[]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">poscar</span><span class="p">)</span> <span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span> <span class="o">=</span> <span class="n">poscar</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">poscar</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">poscar</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">poscar</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">poscar</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lines</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="n">a3</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist or not 3 by 3 list.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">poscar</span><span class="p">))</span>
    <span class="c1"># Process</span>
    <span class="n">V</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="p">))</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="p">)</span><span class="o">/</span><span class="n">V</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a3</span><span class="p">,</span><span class="n">a1</span><span class="p">)</span><span class="o">/</span><span class="n">V</span>
    <span class="n">b3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">)</span><span class="o">/</span><span class="n">V</span>
    <span class="n">s_f</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="n">b1</span><span class="p">))</span>
    <span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">,</span><span class="n">b3</span> <span class="o">=</span> <span class="n">b1</span><span class="o">/</span><span class="n">s_f</span><span class="p">,</span><span class="n">b2</span><span class="o">/</span><span class="n">s_f</span><span class="p">,</span><span class="n">b3</span><span class="o">/</span><span class="n">s_f</span> <span class="c1"># Normalize vectors</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">,</span><span class="n">b3</span><span class="p">])</span>
    <span class="c1"># Get other vectors for BZ</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">b1</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">b2</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">b3</span><span class="p">)</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>
    <span class="c1"># Generate voronoi diagram</span>
    <span class="n">vor</span> <span class="o">=</span> <span class="n">Voronoi</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>
    <span class="n">faces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vrd</span> <span class="o">=</span> <span class="n">vor</span><span class="o">.</span><span class="n">ridge_dict</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">vrd</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">verts_in_face</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vor</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vrd</span><span class="p">[</span><span class="n">r</span><span class="p">]])</span>
            <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">verts_in_face</span><span class="p">)</span>
    <span class="n">faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">faces</span><span class="p">)</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">faces</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">]</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">face_vectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">:</span>
        <span class="n">face_vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">centroid</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">loop</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">face</span><span class="p">)</span> <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">]</span> <span class="c1"># order in a loop</span>
    <span class="c1"># High symmerty KPOINTS in primitive BZ (positive only)</span>
    <span class="n">mid_faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">centroid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">face</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">])</span>
    <span class="n">mid_edges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Do not insert point between unique vertices</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">mid_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">centroid</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]))</span>
    <span class="k">if</span> <span class="n">mid_edges</span><span class="o">!=</span><span class="p">[]:</span>
        <span class="n">mid_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mid_edges</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># because faces share edges</span>
        <span class="n">mid_faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">mid_faces</span><span class="p">,</span><span class="n">mid_edges</span><span class="p">])</span>
    <span class="c1"># Bring all high symmetry points together.</span>
    <span class="n">mid_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span><span class="n">mid_faces</span><span class="p">,</span><span class="n">verts</span><span class="p">])</span>
    <span class="n">mid_basis_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mid_all</span><span class="p">])</span>

    <span class="c1"># Round off results</span>
    <span class="n">mid_all_p</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mid_all</span><span class="p">,</span><span class="n">digits</span><span class="p">)</span>
    <span class="n">mid_basis_p</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mid_basis_all</span><span class="p">,</span><span class="n">digits</span><span class="p">)</span>
    <span class="n">bais</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">digits</span><span class="p">)</span>
    <span class="n">face_vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">face_vectors</span><span class="p">,</span><span class="n">digits</span><span class="p">)</span>
    <span class="n">verts</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span><span class="n">digits</span><span class="p">)</span>
    <span class="n">faces</span>        <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">face</span><span class="p">,</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">]</span>
    <span class="n">one_to_one</span>   <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">):</span><span class="nb">tuple</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mid_basis_p</span><span class="p">,</span><span class="n">mid_all_p</span><span class="p">)}</span>
    <span class="n">BZ</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;BZ&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">,</span> <span class="s1">&#39;normals&#39;</span><span class="p">,</span><span class="s1">&#39;vertices&#39;</span><span class="p">,</span><span class="s1">&#39;faces&#39;</span><span class="p">,</span><span class="s1">&#39;specials&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">BZ</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">face_vectors</span><span class="p">,</span><span class="n">verts</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">faces</span><span class="p">),</span><span class="n">one_to_one</span><span class="p">)</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="plot_bz"><a class="viewcode-back" href="../../api.html#pivotpy.sio.plot_bz">[docs]</a><span class="k">def</span> <span class="nf">plot_bz</span><span class="p">(</span><span class="n">poscar_or_bz</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;rgba(168,204,216,0.4)&#39;</span><span class="p">,</span><span class="n">background</span> <span class="o">=</span> <span class="s1">&#39;rgb(255,255,255)&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Plots interactive figure showing axes,BZ surface, special points and basis, each of which could be hidden or shown.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - pocar_or_bz: POSCAR or 3 basis vectors&#39; list forming POSCAR. Auto picks in working directory. Output of get_bz() also works.</span>
<span class="sd">        - fill       : True by defult, determines whether to fill surface of BZ or not.</span>
<span class="sd">        - color      : color to fill surface &#39;rgba((168,204,216,0.4)` by default.</span>
<span class="sd">        - background : Plot background color, default is &#39;rgb(255,255,255)&#39;.</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - fig   : plotly.graph_object&#39;s Figure instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">poscar_or_bz</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bz</span> <span class="o">=</span> <span class="n">get_bz</span><span class="p">(</span><span class="n">poscar_or_bz</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">poscar_or_bz</span><span class="o">.</span><span class="n">basis</span>
            <span class="n">bz</span> <span class="o">=</span> <span class="n">poscar_or_bz</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">bz</span> <span class="o">=</span> <span class="n">get_bz</span><span class="p">(</span><span class="n">poscar_or_bz</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="c1"># Axes</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mf">0.25</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.25</span><span class="p">],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines+text&#39;</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;b&gt;k&lt;/b&gt;&lt;sub&gt;x&lt;/sub&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;b&gt;k&lt;/b&gt;&lt;sub&gt;y&lt;/sub&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;b&gt;k&lt;/b&gt;&lt;sub&gt;z&lt;/sub&gt;&quot;</span><span class="p">],</span>
        <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Axes&#39;</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Cone</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mf">0.18</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.18</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.18</span><span class="p">],</span>
        <span class="n">u</span><span class="o">=</span><span class="p">[</span><span class="mf">0.00001</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.00001</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>    <span class="mf">0.00001</span><span class="p">],</span><span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span><span class="p">,</span><span class="n">legendgroup</span><span class="o">=</span><span class="s1">&#39;Axes&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Axes&#39;</span><span class="p">))</span>
    <span class="c1"># Basis</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bz</span><span class="o">.</span><span class="n">basis</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines+text&#39;</span><span class="p">,</span><span class="n">legendgroup</span><span class="o">=</span><span class="s2">&quot;b&lt;sub&gt;</span><span class="si">{}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&lt;b&gt;b&lt;/b&gt;&lt;sub&gt;</span><span class="si">{}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;b&gt;b&lt;/b&gt;&lt;sub&gt;</span><span class="si">{}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Cone</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="n">u</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">v</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="o">*</span><span class="n">b</span>  <span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span>
            <span class="n">legendgroup</span><span class="o">=</span><span class="s2">&quot;b&lt;sub&gt;</span><span class="si">{}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&lt;b&gt;b&lt;/b&gt;&lt;sub&gt;</span><span class="si">{}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>

    <span class="c1"># Faces</span>
    <span class="n">face_ind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fill_axis</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Placeholder</span>
    <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">pts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bz</span><span class="o">.</span><span class="n">faces</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fill</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
            <span class="n">fill_axis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">fill</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">face_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">centroid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span> <span class="c1"># same fill axis in negative axes too</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">face_dir</span><span class="p">)</span> <span class="o">==</span> <span class="n">face_dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">fill_axis</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">face_dir</span><span class="p">)</span> <span class="o">==</span> <span class="n">face_dir</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">fill_axis</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">face_dir</span><span class="p">)</span> <span class="o">==</span> <span class="n">face_dir</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">fill_axis</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">z</span><span class="o">=</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>    <span class="n">legendgroup</span><span class="o">=</span><span class="s1">&#39;BZ&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;BZ&#39;</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span><span class="n">surfaceaxis</span><span class="o">=</span><span class="n">fill_axis</span><span class="p">))</span>

    <span class="c1"># Special Points</span>
    <span class="n">texts</span><span class="p">,</span><span class="n">values</span> <span class="o">=</span><span class="p">[],[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">bz</span><span class="o">.</span><span class="n">specials</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">value</span><span class="p">),</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;P</span><span class="si">{}</span><span class="s2">&lt;/br&gt;d = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">norm</span><span class="p">))</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="o">*</span><span class="n">value</span><span class="p">,</span><span class="n">norm</span><span class="p">]])</span>

    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">norm_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">[:,</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">c_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="mi">255</span><span class="o">/</span><span class="n">norm_max</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]])</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">c_vals</span><span class="p">]</span>
    <span class="n">_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">c_vals</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">_lnp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">_unique</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">_u_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rgb(</span><span class="si">{}</span><span class="s2">,0,</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_lnp</span><span class="p">,</span><span class="n">_lnp</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">for</span> <span class="n">_un</span><span class="p">,</span><span class="n">_uc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_unique</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">_u_colors</span><span class="p">):</span>
        <span class="n">_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c_vals</span> <span class="o">==</span> <span class="n">_un</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">_ind</span> <span class="ow">in</span> <span class="n">_index</span><span class="p">:</span>
            <span class="n">colors</span><span class="p">[</span><span class="n">_ind</span><span class="p">]</span><span class="o">=</span><span class="n">_uc</span>

    <span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="s2">&quot;rgb(255,215,0)&quot;</span> <span class="c1"># Gold color at Gamma!.</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">z</span><span class="o">=</span><span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">hovertext</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;HSK&quot;</span><span class="p">,</span><span class="n">marker_color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">))</span>

    <span class="n">camera</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene_camera</span><span class="o">=</span><span class="n">camera</span><span class="p">,</span><span class="n">paper_bgcolor</span><span class="o">=</span><span class="n">background</span><span class="p">,</span>
        <span class="n">font_family</span><span class="o">=</span><span class="s2">&quot;Times New Roman&quot;</span><span class="p">,</span><span class="n">font_size</span><span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
        <span class="n">scene</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">aspectmode</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="n">xaxis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">showbackground</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                        <span class="n">yaxis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">showbackground</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                        <span class="n">zaxis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">showbackground</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
                        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fig</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Abdul Saboor

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>