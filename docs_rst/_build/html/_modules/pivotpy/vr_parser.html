

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pivotpy.vr_parser &mdash; pivotpy 0.9.9 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> pivotpy
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Pivotpy API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pivotpy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pivotpy.vr_parser</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pivotpy.vr_parser</h1><div class="highlight"><pre>
<span></span><span class="c1"># AUTOGENERATED! DO NOT EDIT! File to edit: XmlElementTree.ipynb (unless otherwise specified).</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Dict2Data&#39;</span><span class="p">,</span> <span class="s1">&#39;read_asxml&#39;</span><span class="p">,</span> <span class="s1">&#39;exclude_kpts&#39;</span><span class="p">,</span> <span class="s1">&#39;get_ispin&#39;</span><span class="p">,</span> <span class="s1">&#39;get_summary&#39;</span><span class="p">,</span> <span class="s1">&#39;get_kpts&#39;</span><span class="p">,</span> <span class="s1">&#39;get_tdos&#39;</span><span class="p">,</span> <span class="s1">&#39;get_evals&#39;</span><span class="p">,</span>
           <span class="s1">&#39;get_bands_pro_set&#39;</span><span class="p">,</span> <span class="s1">&#39;get_dos_pro_set&#39;</span><span class="p">,</span> <span class="s1">&#39;get_structure&#39;</span><span class="p">,</span> <span class="s1">&#39;export_vasprun&#39;</span><span class="p">,</span> <span class="s1">&#39;load_export&#39;</span><span class="p">,</span> <span class="s1">&#39;dump_dict&#39;</span><span class="p">,</span>
           <span class="s1">&#39;load_from_dump&#39;</span><span class="p">,</span> <span class="s1">&#39;islice2array&#39;</span><span class="p">,</span> <span class="s1">&#39;slice_data&#39;</span><span class="p">,</span> <span class="s1">&#39;split_vasprun&#39;</span><span class="p">]</span>

<span class="c1"># Cell</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">product</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">importlib.machinery</span> <span class="kn">import</span> <span class="n">SourceFileLoader</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">pivotpy.g_utils</span> <span class="k">as</span> <span class="nn">gu</span>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="Dict2Data"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.Dict2Data">[docs]</a><span class="k">class</span> <span class="nc">Dict2Data</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns a Data object with dictionary keys as attributes of Data accessible by dot notation.</span>
<span class="sd">    - **Parmeters**</span>
<span class="sd">        - dict : Python dictionary (nested as well) containing any python data types.</span>
<span class="sd">    - **Methods**</span>
<span class="sd">        - to_dict()  : Converts a Data object to dictionary if it could be made a dictionary, otherwise throws relevant error.</span>
<span class="sd">        - to_json()  : Converts to json str or save to file if `outfil` given. Accepts `indent` as parameter.</span>
<span class="sd">        - to_pickle(): Converts to bytes str or save to file if `outfile` given.</span>
<span class="sd">    - **Example**</span>
<span class="sd">        &gt; x = Dict2Data({&#39;A&#39;:1,&#39;B&#39;:{&#39;C&#39;:2}})</span>
<span class="sd">        &gt; x</span>
<span class="sd">        &gt; Data(</span>
<span class="sd">        &gt;     A = 1</span>
<span class="sd">        &gt;     B = Data(</span>
<span class="sd">        &gt;         C = 2</span>
<span class="sd">        &gt;         )</span>
<span class="sd">        &gt;     )</span>
<span class="sd">        &gt; x.B.to_dict()</span>
<span class="sd">        &gt; {&#39;C&#39;: 2}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">Dict2Data</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="c1"># if nested Dict2Dataects, must expand here.</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">Dict2Data</span><span class="p">):</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="c1"># expands self instance !must here.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">,[</span><span class="n">Dict2Data</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">b</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">Dict2Data</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - Converts a `Dict2Data` object (root or nested level) to a dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">Dict2Data</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span><span class="n">Dict2Data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">v</span><span class="p">)})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span><span class="n">v</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - Dumps a `Dict2Data` object (root or nested level) to json.</span>
<span class="sd">        - **Parameters**</span>
<span class="sd">            - outfile : Default is None and returns string. If given, writes to file.</span>
<span class="sd">            - indent  : Json indent. Default is 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dump_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dump_to</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - Dumps a `Dict2Data` object (root or nested level) to pickle.</span>
<span class="sd">        - **Parameters**</span>
<span class="sd">            - outfile : Default is None and returns string. If given, writes to file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dump_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dump_to</span><span class="o">=</span><span class="s1">&#39;pickle&#39;</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">items</span><span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">range</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">Dict2Data</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">:shape=</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">:len=</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">Dict2Data</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;Data(</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>  <span class="c1">#This is for pickling</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="read_asxml"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.read_asxml">[docs]</a><span class="k">def</span> <span class="nf">read_asxml</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Reads a big vasprun.xml file into memory once and then apply commands. If current folder contains `vasprun.xml` file, it automatically picks it.</span>

<span class="sd">    - **Parameters**</span>
<span class="sd">        - path : Path/To/vasprun.xml</span>

<span class="sd">    - **Returns**</span>
<span class="sd">        - xml_data : Xml object to use in other functions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">path</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./vasprun.xml&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File: &#39;</span><span class="si">{}</span><span class="s2">&#39;&#39; does not exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="c1"># This is important to stop further errors.</span>
    <span class="k">elif</span> <span class="s1">&#39;vasprun.xml&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File should end with &#39;vasprun.xml&#39;, prefixes are allowed.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1"># This is important to stop further errors.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fsize</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">get_file_size</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fsize</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">print_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Memory Consumption Warning!</span>
<span class="s2">        ---------------------------</span>
<span class="s2">        File: </span><span class="si">{}</span><span class="s2"> is large (</span><span class="si">{}</span><span class="s2">). It may consume a lot of memory (generally 3 times the file size).</span>
<span class="s2">            An alternative way is to parse vasprun.xml is by using `Vasp2Visual` module in Powershell by command `pivotpy.load_export(&#39;path/to/vasprun.xml&#39;), which runs underlying powershell functions to load data whith efficient memory managment. It works on Windows/Linux/MacOS if you have powershell core and Vasp2Visual installed on it.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">fsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;MB&#39;</span> <span class="ow">in</span> <span class="n">fsize</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">gu</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">print_str</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="s1">&#39;GB&#39;</span> <span class="ow">in</span> <span class="n">fsize</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">gu</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">print_str</span><span class="p">)))</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">xml_data</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">xml_data</span></div>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">exclude_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns number of kpoints to exclude used from IBZKPT.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - xml_data : From `read_asxml` function</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - int      : Number of kpoints to exclude.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">xml_data</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">xml_data</span><span class="o">=</span><span class="n">read_asxml</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_data</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">kpts</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;varray&#39;</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">kpts</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;weights&#39;</span><span class="p">}):</span>
            <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">kpts</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)]</span>
    <span class="n">exclude</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">[</span><span class="n">exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">weights</span> <span class="k">if</span> <span class="n">item</span><span class="o">!=</span><span class="n">weights</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]];</span>
    <span class="n">skipk</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span> <span class="c1">#that much to skip</span>
    <span class="k">return</span> <span class="n">skipk</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">get_ispin</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns value of ISPIN.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - xml_data : From `read_asxml` function</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - int      : Value of ISPIN.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">xml_data</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">xml_data</span><span class="o">=</span><span class="n">read_asxml</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_data</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ISPIN&#39;</span><span class="p">}):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="get_summary"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.get_summary">[docs]</a><span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns overview of system parameters.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - xml_data : From `read_asxml` function</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - Data     : pivotpy.Dict2Data with attibutes accessible via dot notation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">xml_data</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">xml_data</span><span class="o">=</span><span class="n">read_asxml</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_data</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">i_car</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;incar&#39;</span><span class="p">):</span>
        <span class="n">incar</span><span class="o">=</span><span class="p">{</span><span class="n">car</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span><span class="n">car</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">car</span> <span class="ow">in</span> <span class="n">i_car</span><span class="p">}</span>
    <span class="n">n_ions</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;atoms&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">type_ions</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">atom_types</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom_types</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;types&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">elem</span><span class="o">=</span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;rc&#39;</span><span class="p">)]</span>
    <span class="n">elem_name</span><span class="o">=</span><span class="p">[];</span> <span class="c1">#collect IONS names</span>
    <span class="p">[</span><span class="n">elem_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">[:</span><span class="o">-</span><span class="n">type_ions</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">elem_name</span><span class="p">]</span>
    <span class="n">elem_index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">#start index</span>
    <span class="p">[</span><span class="n">elem_index</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="o">+</span><span class="n">elem_index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">[</span><span class="o">-</span><span class="n">type_ions</span><span class="p">:]];</span>
    <span class="n">ISPIN</span><span class="o">=</span><span class="n">get_ispin</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span>
    <span class="c1"># Fields</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pro</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;partial&#39;</span><span class="p">):</span>
            <span class="n">dos_fields</span><span class="o">=</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">pro</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">)]</span>
            <span class="n">dos_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dos_fields</span> <span class="k">if</span> <span class="s1">&#39;energy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">dos_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">):</span> <span class="c1">#efermi for condition required.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;efermi&#39;</span><span class="p">}):</span>
            <span class="n">efermi</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="c1">#Writing information to a dictionary</span>
    <span class="n">info_dic</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">:</span><span class="n">incar</span><span class="p">[</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">],</span><span class="s1">&#39;NION&#39;</span><span class="p">:</span><span class="n">n_ions</span><span class="p">,</span><span class="s1">&#39;TypeION&#39;</span><span class="p">:</span><span class="n">type_ions</span><span class="p">,</span><span class="s1">&#39;ElemName&#39;</span><span class="p">:</span><span class="n">elem_name</span><span class="p">,</span><span class="s1">&#39;ElemIndex&#39;</span><span class="p">:</span><span class="n">elem_index</span><span class="p">,</span>\
        <span class="s1">&#39;E_Fermi&#39;</span><span class="p">:</span> <span class="n">efermi</span><span class="p">,</span><span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span><span class="n">ISPIN</span><span class="p">,</span><span class="s1">&#39;fields&#39;</span><span class="p">:</span><span class="n">dos_fields</span><span class="p">,</span><span class="s1">&#39;incar&#39;</span><span class="p">:</span><span class="n">incar</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">Dict2Data</span><span class="p">(</span><span class="n">info_dic</span><span class="p">)</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="get_kpts"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.get_kpts">[docs]</a><span class="k">def</span> <span class="nf">get_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">joinPathAt</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns kpoints and calculated kpath.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xml_data</span>
<span class="sd">        From `read_asxml` function.</span>

<span class="sd">    skipk : int</span>
<span class="sd">        Number of initil kpoints to skip.</span>

<span class="sd">    joinPathAt : list</span>
<span class="sd">        List of indices of kpoints where path is broken.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Data : pivotpy.Dict2Data</span>
<span class="sd">        with attibutes `kpath` and `kpoints`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    get_kpath</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Notes about the implementation algorithm (if needed).</span>
<span class="sd">    This can have multiple paragraphs.</span>
<span class="sd">    You may include some math:</span>

<span class="sd">    .. math:: X(e^{j\omega } ) = x(n)e^{ - j\omega n}</span>

<span class="sd">    And even use a greek symbol like :math:`omega` inline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">xml_data</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">xml_data</span><span class="o">=</span><span class="n">read_asxml</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_data</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">kpts</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;varray&#39;</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">kpts</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;kpointlist&#39;</span><span class="p">}):</span>
            <span class="n">kpoints</span><span class="o">=</span><span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">kpts</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)]</span>
    <span class="n">kpoints</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kpoints</span><span class="p">[</span><span class="n">skipk</span><span class="p">:])</span>
    <span class="c1">#KPath solved.</span>
    <span class="n">kpath</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="n">pts</span><span class="o">=</span><span class="n">kpoints</span>
    <span class="p">[</span><span class="n">kpath</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pt1</span><span class="o">-</span><span class="n">pt2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="n">kpath</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">6</span><span class="p">))</span> <span class="k">for</span> <span class="n">pt1</span><span class="p">,</span><span class="n">pt2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
    <span class="c1"># If broken path, then join points.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">joinPathAt</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">joinPathAt</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">joinPathAt</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">joinPathAt</span><span class="p">:</span>
            <span class="n">kpath</span><span class="p">[</span><span class="n">pt</span><span class="p">:]</span><span class="o">=</span><span class="n">kpath</span><span class="p">[</span><span class="n">pt</span><span class="p">:]</span><span class="o">-</span><span class="n">kpath</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span><span class="o">+</span><span class="n">kpath</span><span class="p">[</span><span class="n">pt</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Dict2Data</span><span class="p">({</span><span class="s1">&#39;NKPTS&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">kpoints</span><span class="p">),</span><span class="s1">&#39;kpoints&#39;</span><span class="p">:</span><span class="n">kpoints</span><span class="p">,</span><span class="s1">&#39;kpath&#39;</span><span class="p">:</span><span class="n">kpath</span><span class="p">})</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="get_tdos"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.get_tdos">[docs]</a><span class="k">def</span> <span class="nf">get_tdos</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">elim</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns total dos for a spin_set (default 1) and energy limit. If spin-polarized calculations, gives SpinUp and SpinDown keys as well.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - xml_data : From `read_asxml` function</span>
<span class="sd">        - spin_set : int, default is 1.and</span>
<span class="sd">        - elim     : List [min,max] of energy, default empty.</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - Data     : pivotpy.Dict2Data with attibutes E_Fermi, ISPIN,tdos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">xml_data</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">xml_data</span><span class="o">=</span><span class="n">read_asxml</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_data</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">tdos</span><span class="o">=</span><span class="p">[];</span> <span class="c1">#assign for safely exit if wrong spin set entered.</span>
    <span class="n">ISPIN</span> <span class="o">=</span> <span class="n">get_ispin</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;dos&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">neighbor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">spin_set</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin 1&#39;</span><span class="p">}):</span>
                    <span class="n">tdos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])</span>
            <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">spin_set</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin 1&#39;</span><span class="p">}):</span>
                    <span class="n">tdos_1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin 2&#39;</span><span class="p">}):</span>
                    <span class="n">tdos_2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])</span>
                    <span class="n">tdos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">tdos_1</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span><span class="n">tdos_2</span><span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">spin_set</span><span class="o">!=</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#can get any</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spin_set</span><span class="p">)}):</span>
                    <span class="n">tdos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">):</span> <span class="c1">#efermi for condition required.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;efermi&#39;</span><span class="p">}):</span>
            <span class="n">efermi</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">dos_dic</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E_Fermi&#39;</span><span class="p">:</span><span class="n">efermi</span><span class="p">,</span><span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span><span class="n">ISPIN</span><span class="p">,</span><span class="s1">&#39;tdos&#39;</span><span class="p">:</span><span class="n">tdos</span><span class="p">}</span>
    <span class="c1">#Filtering in energy range.</span>
    <span class="k">if</span> <span class="n">elim</span><span class="p">:</span> <span class="c1">#check if elim not empty</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">spin_set</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">up_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elim</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">lo_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&gt;=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">elim</span><span class="p">)))</span>
            <span class="n">tdos</span><span class="o">=</span><span class="n">tdos</span><span class="p">[</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">,:]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">spin_set</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">up_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdos</span><span class="p">[</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elim</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">lo_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdos</span><span class="p">[</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&gt;=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">elim</span><span class="p">)))</span>
            <span class="n">tdos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">tdos_1</span><span class="p">[</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">,:],</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span><span class="n">tdos_2</span><span class="p">[</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">,:]}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">spin_set</span><span class="o">!=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">up_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elim</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">lo_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&gt;=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">elim</span><span class="p">)))</span>
            <span class="n">tdos</span><span class="o">=</span><span class="n">tdos</span><span class="p">[</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">,:]</span>
        <span class="n">dos_dic</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E_Fermi&#39;</span><span class="p">:</span><span class="n">efermi</span><span class="p">,</span><span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span><span class="n">ISPIN</span><span class="p">,</span><span class="s1">&#39;grid_range&#39;</span><span class="p">:</span><span class="nb">range</span><span class="p">(</span><span class="n">lo_ind</span><span class="p">,</span><span class="n">up_ind</span><span class="p">),</span><span class="s1">&#39;tdos&#39;</span><span class="p">:</span><span class="n">tdos</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">Dict2Data</span><span class="p">(</span><span class="n">dos_dic</span><span class="p">)</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="get_evals"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.get_evals">[docs]</a><span class="k">def</span> <span class="nf">get_evals</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">elim</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns eigenvalues as numpy array. If spin-polarized calculations, gives SpinUp and SpinDown keys as well.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - xml_data : From `read_asxml` function</span>
<span class="sd">        - skipk    : Number of initil kpoints to skip.</span>
<span class="sd">        - elim     : List [min,max] of energy, default empty.</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - Data     : pivotpy.Dict2Data with attibutes evals and related parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">xml_data</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">xml_data</span><span class="o">=</span><span class="n">read_asxml</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_data</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">evals</span><span class="o">=</span><span class="p">[];</span> <span class="c1">#assign for safely exit if wrong spin set entered.</span>
    <span class="n">ISPIN</span><span class="o">=</span><span class="n">get_ispin</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">skipk</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">skipk</span><span class="o">=</span><span class="n">exclude_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span> <span class="c1">#that much to skip by default</span>
    <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;eigenvalues&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">neighbor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin 1&#39;</span><span class="p">}):</span>
                    <span class="n">evals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">]</span> <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])[</span><span class="n">skipk</span><span class="p">:]</span>
                    <span class="n">NBANDS</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">evals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin 1&#39;</span><span class="p">}):</span>
                    <span class="n">eval_1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">]</span> <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])[</span><span class="n">skipk</span><span class="p">:]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin 2&#39;</span><span class="p">}):</span>
                    <span class="n">eval_2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">th</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">]</span> <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])[</span><span class="n">skipk</span><span class="p">:]</span>
                    <span class="n">evals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">eval_1</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span><span class="n">eval_2</span><span class="p">}</span>
                    <span class="n">NBANDS</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">eval_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">):</span> <span class="c1">#efermi for condition required.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;efermi&#39;</span><span class="p">}):</span>
            <span class="n">efermi</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">evals_dic</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;E_Fermi&#39;</span><span class="p">:</span><span class="n">efermi</span><span class="p">,</span><span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span><span class="n">ISPIN</span><span class="p">,</span><span class="s1">&#39;NBANDS&#39;</span><span class="p">:</span><span class="n">NBANDS</span><span class="p">,</span><span class="s1">&#39;evals&#39;</span><span class="p">:</span><span class="n">evals</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">elim</span><span class="p">:</span> <span class="c1">#check if elim not empty</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">up_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evals</span><span class="p">[:,:]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elim</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">lo_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evals</span><span class="p">[:,:]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&gt;=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">elim</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">evals</span><span class="o">=</span><span class="n">evals</span><span class="p">[:,</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">up_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eval_1</span><span class="p">[:,:]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elim</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">lo_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eval_1</span><span class="p">[:,:]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&gt;=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">elim</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">evals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">eval_1</span><span class="p">[:,</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">],</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span><span class="n">eval_2</span><span class="p">[:,</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">]}</span>
        <span class="n">NBANDS</span><span class="o">=</span><span class="n">up_ind</span><span class="o">-</span><span class="n">lo_ind</span> <span class="c1">#update Bands</span>
        <span class="n">evals_dic</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;E_Fermi&#39;</span><span class="p">:</span><span class="n">efermi</span><span class="p">,</span><span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span><span class="n">ISPIN</span><span class="p">,</span><span class="s1">&#39;NBANDS&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">NBANDS</span><span class="p">),</span><span class="s1">&#39;bands_range&#39;</span><span class="p">:</span><span class="nb">range</span><span class="p">(</span><span class="n">lo_ind</span><span class="p">,</span><span class="n">up_ind</span><span class="p">),</span><span class="s1">&#39;evals&#39;</span><span class="p">:</span><span class="n">evals</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">Dict2Data</span><span class="p">(</span><span class="n">evals_dic</span><span class="p">)</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="get_bands_pro_set"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.get_bands_pro_set">[docs]</a><span class="k">def</span> <span class="nf">get_bands_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">skipk</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">bands_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">set_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns bands projection of a spin_set(default 1). If spin-polarized calculations, gives SpinUp and SpinDown keys as well.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - xml_data    : From `read_asxml` function</span>
<span class="sd">        - skipk       : Number of initil kpoints to skip (Default 0).</span>
<span class="sd">        - spin_set    : Spin set to get, default is 1.</span>
<span class="sd">        - bands_range : If elim used in `get_evals`,that will return bands_range to use here. Note that range(0,2) will give 2 bands 0,1 but tuple (0,2) will give 3 bands 0,1,2.</span>
<span class="sd">        - set_path     : path/to/_set[1,2,3,4].txt, works if `split_vasprun` is used before.</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - Data     : pivotpy.Dict2Data with attibutes of bands projections and related parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bands_range</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">check_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">bands_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_list</span><span class="o">==</span><span class="p">[]:</span>
            <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="n">gu</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s2">&quot;No bands prjections found in given energy range.&quot;</span><span class="p">))</span>
    <span class="c1"># Try to read _set.txt first. instance check is important.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">set_path</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">set_path</span><span class="p">):</span>
        <span class="n">_header</span> <span class="o">=</span> <span class="n">islice2array</span><span class="p">(</span><span class="n">set_path</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">_shape</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="n">NKPTS</span><span class="p">,</span> <span class="n">NBANDS</span><span class="p">,</span> <span class="n">NIONS</span><span class="p">,</span> <span class="n">NORBS</span> <span class="o">=</span> <span class="n">_shape</span>
        <span class="k">if</span> <span class="n">NORBS</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">NORBS</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;py&#39;</span><span class="p">,</span><span class="s1">&#39;pz&#39;</span><span class="p">,</span><span class="s1">&#39;px&#39;</span><span class="p">,</span><span class="s1">&#39;dxy&#39;</span><span class="p">,</span><span class="s1">&#39;dyz&#39;</span><span class="p">,</span><span class="s1">&#39;dz2&#39;</span><span class="p">,</span><span class="s1">&#39;dxz&#39;</span><span class="p">,</span><span class="s1">&#39;x2-y2&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NORBS</span><span class="p">)]</span> <span class="c1">#s,p,d in indices.</span>
        <span class="n">COUNT</span> <span class="o">=</span> <span class="n">NIONS</span><span class="o">*</span><span class="n">NBANDS</span><span class="o">*</span><span class="p">(</span><span class="n">NKPTS</span><span class="o">-</span><span class="n">skipk</span><span class="p">)</span><span class="o">*</span><span class="n">NORBS</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">NBANDS</span><span class="o">*</span><span class="n">NIONS</span><span class="o">*</span><span class="n">skipk</span>
        <span class="n">nlines</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Read till end.</span>
        <span class="k">if</span> <span class="n">bands_range</span><span class="p">:</span>
            <span class="n">_b_r</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bands_range</span><span class="p">)</span>
            <span class="c1"># First line is comment but it is taken out by exclude in islice2array.</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NIONS</span><span class="o">*</span><span class="n">NBANDS</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="n">NIONS</span><span class="o">*</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_b_r</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skipk</span><span class="p">,</span><span class="n">NKPTS</span><span class="p">)]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">start</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ss</span><span class="p">]</span> <span class="c1">#flatten</span>
            <span class="n">nlines</span> <span class="o">=</span> <span class="n">NIONS</span> <span class="c1"># 1 band has nions</span>
            <span class="n">NBANDS</span> <span class="o">=</span> <span class="n">_b_r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">_b_r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="c1"># upadte after start</span>

        <span class="n">NKPTS</span> <span class="o">=</span> <span class="n">NKPTS</span><span class="o">-</span><span class="n">skipk</span> <span class="c1"># Update after start, and bands_range.</span>
        <span class="n">COUNT</span> <span class="o">=</span> <span class="n">NIONS</span><span class="o">*</span><span class="n">NBANDS</span><span class="o">*</span><span class="n">NKPTS</span><span class="o">*</span><span class="n">NORBS</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">islice2array</span><span class="p">(</span><span class="n">set_path</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="n">nlines</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="n">COUNT</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">NKPTS</span><span class="p">,</span><span class="n">NBANDS</span><span class="p">,</span><span class="n">NIONS</span><span class="p">,</span><span class="n">NORBS</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Dict2Data</span><span class="p">({</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">fields</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">})</span>

    <span class="c1"># if above not worked, read from main vasprun.xml file.</span>
    <span class="k">if</span><span class="p">(</span><span class="n">xml_data</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">xml_data</span><span class="o">=</span><span class="n">read_asxml</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_data</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1">#Collect Projection fields</span>
    <span class="n">fields</span><span class="o">=</span><span class="p">[];</span>
    <span class="k">for</span> <span class="n">pro</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;projected&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">pro</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="s1">&#39;eig&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="s1">&#39;occ&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">NORBS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
    <span class="c1">#Get NIONS for reshaping data</span>
    <span class="n">NIONS</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;atoms&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spin</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spin_set</span><span class="p">)}:</span>
            <span class="n">k_sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">kp</span> <span class="k">for</span> <span class="n">kp</span> <span class="ow">in</span> <span class="n">spin</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;kpoint&#39;</span> <span class="ow">in</span> <span class="n">kp</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]]</span>
    <span class="n">k_sets</span> <span class="o">=</span> <span class="n">k_sets</span><span class="p">[</span><span class="n">skipk</span><span class="p">:]</span>
    <span class="n">NKPTS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_sets</span><span class="p">)</span>
    <span class="n">band_sets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k_s</span> <span class="ow">in</span> <span class="n">k_sets</span><span class="p">:</span>
        <span class="n">b_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">k_s</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;band&#39;</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">bands_range</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">band_sets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b_set</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b_r</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bands_range</span><span class="p">)</span>
            <span class="n">band_sets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b_set</span><span class="p">[</span><span class="n">b_r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">b_r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">NBANDS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">band_sets</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">k_sets</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Error prone solution but 5 times fater than list comprehension.</span>
        <span class="n">bands_pro</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">band_sets</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">band</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="n">COUNT</span> <span class="o">=</span> <span class="n">NKPTS</span><span class="o">*</span><span class="n">NBANDS</span><span class="o">*</span><span class="n">NORBS</span><span class="o">*</span><span class="n">NIONS</span> <span class="c1"># Must be counted for performance.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">bands_pro</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="n">COUNT</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># Alternate slow solution</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error using `np.fromiter`.</span><span class="se">\n</span><span class="s2">Falling back to (slow) list comprehension...&quot;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">bands_pro</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">band_sets</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">band</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
        <span class="n">bands_pro</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">bands_pro</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bands_pro</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">bands_pro</span> <span class="c1"># Release memory</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">NKPTS</span><span class="p">,</span><span class="n">NBANDS</span><span class="p">,</span><span class="n">NIONS</span><span class="p">,</span><span class="n">NORBS</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Dict2Data</span><span class="p">({</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">fields</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">})</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="get_dos_pro_set"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.get_dos_pro_set">[docs]</a><span class="k">def</span> <span class="nf">get_dos_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dos_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns dos projection of a spin_set(default 1) as numpy array. If spin-polarized calculations, gives SpinUp and SpinDown keys as well.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - xml_data    : From `read_asxml` function</span>
<span class="sd">        - spin_set    : Spin set to get, default 1.</span>
<span class="sd">        - dos_range   : If elim used in `get_tdos`,that will return dos_range to use here..</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - Data     : pivotpy.Dict2Data with attibutes of dos projections and related parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dos_range</span><span class="o">!=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">check_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dos_range</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">check_list</span><span class="o">==</span><span class="p">[]):</span>
            <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="n">gu</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s2">&quot;No DOS prjections found in given energy range.&quot;</span><span class="p">))</span>
    <span class="k">if</span><span class="p">(</span><span class="n">xml_data</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">xml_data</span><span class="o">=</span><span class="n">read_asxml</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_data</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">n_ions</span><span class="o">=</span><span class="n">get_summary</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span><span class="o">.</span><span class="n">NION</span>
    <span class="k">for</span> <span class="n">pro</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;partial&#39;</span><span class="p">):</span>
        <span class="n">dos_fields</span><span class="o">=</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">pro</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">)]</span>
        <span class="c1">#Collecting projections.</span>
        <span class="n">dos_pro</span><span class="o">=</span><span class="p">[];</span> <span class="n">set_pro</span><span class="o">=</span><span class="p">[];</span> <span class="c1">#set_pro=[] in case spin set does not exists</span>
        <span class="k">for</span> <span class="n">ion</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ions</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pro</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;ion </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ion</span><span class="o">+</span><span class="mi">1</span><span class="p">)}):</span>
                    <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">spin</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spin_set</span><span class="p">)}):</span>
                            <span class="n">set_pro</span><span class="o">=</span><span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">spin</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)]</span>
            <span class="n">dos_pro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">set_pro</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dos_range</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="c1">#full grid computed.</span>
        <span class="n">dos_pro</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dos_pro</span><span class="p">)</span> <span class="c1">#shape(NION,e_grid,pro_fields)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dos_range</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dos_range</span><span class="p">)</span>
        <span class="n">min_ind</span><span class="o">=</span><span class="n">dos_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_ind</span><span class="o">=</span><span class="n">dos_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">dos_pro</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dos_pro</span><span class="p">)[:,</span><span class="n">min_ind</span><span class="p">:</span><span class="n">max_ind</span><span class="p">,:]</span>
    <span class="n">final_data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dos_pro</span><span class="p">)</span> <span class="c1">#shape(NION,e_grid,pro_fields)</span>
    <span class="k">return</span> <span class="n">Dict2Data</span><span class="p">({</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">dos_fields</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span><span class="n">final_data</span><span class="p">})</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="get_structure"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.get_structure">[docs]</a><span class="k">def</span> <span class="nf">get_structure</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns structure&#39;s volume,basis,positions and rec-basis.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - xml_data : From `read_asxml` function.</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - Data     : pivotpy.Dict2Data with attibutes volume,basis,positions and rec_basis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">xml_data</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">xml_data</span><span class="o">=</span><span class="n">read_asxml</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_data</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">final</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;structure&#39;</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;finalpos&#39;</span><span class="p">}):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">final</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">):</span>
                <span class="n">volume</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">final</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;varray&#39;</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;basis&#39;</span><span class="p">}):</span>
                    <span class="n">basis</span><span class="o">=</span><span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;rec_basis&#39;</span><span class="p">}):</span>
                    <span class="n">rec_basis</span><span class="o">=</span><span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;positions&#39;</span><span class="p">}):</span>
                    <span class="n">positions</span><span class="o">=</span><span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)]</span>
    <span class="n">st_dic</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">volume</span><span class="p">,</span><span class="s1">&#39;basis&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">basis</span><span class="p">),</span><span class="s1">&#39;rec_basis&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rec_basis</span><span class="p">),</span><span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">Dict2Data</span><span class="p">(</span><span class="n">st_dic</span><span class="p">)</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="export_vasprun"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.export_vasprun">[docs]</a><span class="k">def</span> <span class="nf">export_vasprun</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">elim</span><span class="o">=</span><span class="p">[],</span><span class="n">joinPathAt</span><span class="o">=</span><span class="p">[],</span><span class="n">shift_kpath</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns a full dictionary of all objects from `vasprun.xml` file. It first try to load the data exported by powershell&#39;s `Export-VR(Vasprun)`, which is very fast for large files. It is recommended to export large files in powershell first.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - path       : Path to `vasprun.xml` file. Default is `&#39;./vasprun.xml&#39;`.</span>
<span class="sd">        - skipk      : Default is None. Automatically detects kpoints to skip.</span>
<span class="sd">        - elim       : List [min,max] of energy interval. Default is [], covers all bands.</span>
<span class="sd">        - joinPathAt : List of indices of kpoints where path is broken.</span>
<span class="sd">        - shift_kpath: Default 0. Can be used to merge multiple calculations on single axes side by side.</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - Data : Data accessible via dot notation containing nested Data objects:</span>
<span class="sd">            - sys_info  : System Information</span>
<span class="sd">            - dim_info  : Contains information about dimensions of returned objects.</span>
<span class="sd">            - kpoints   : numpy array of kpoints with excluded IBZKPT points</span>
<span class="sd">            - kpath     : 1D numpy array directly accessible for plot.</span>
<span class="sd">            - bands     : Data containing bands.</span>
<span class="sd">            - tdos      : Data containing total dos.</span>
<span class="sd">            - pro_bands : Data containing bands projections.</span>
<span class="sd">            - pro_dos   : Data containing dos projections.</span>
<span class="sd">            - poscar    : Data containing basis,positions, rec_basis and volume.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try to get files if exported data in PowerShell.</span>
    <span class="n">req_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bands.txt&#39;</span><span class="p">,</span><span class="s1">&#39;tDOS.txt&#39;</span><span class="p">,</span><span class="s1">&#39;pDOS.txt&#39;</span><span class="p">,</span><span class="s1">&#39;Projection.txt&#39;</span><span class="p">,</span><span class="s1">&#39;SysInfo.py&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">req_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)),</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">req_files</span><span class="p">]</span>
    <span class="n">logic</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">req_files</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">in</span> <span class="n">logic</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading from PowerShell Exported Data...&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">load_export</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="p">(</span><span class="n">path</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="s1">&#39;./vasprun.xml&#39;</span><span class="p">))</span>

    <span class="c1"># Proceed if not files from PWSH</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./vasprun.xml&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">xml_data</span> <span class="o">=</span> <span class="n">read_asxml</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">set_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span><span class="s2">&quot;_set</span><span class="si">{}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span>
    <span class="c1">#First exclude unnecessary kpoints. Includes only same weight points</span>
    <span class="k">if</span> <span class="n">skipk</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">skipk</span> <span class="o">=</span> <span class="n">exclude_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span> <span class="c1">#that much to skip by default</span>
    <span class="n">info_dic</span> <span class="o">=</span> <span class="n">get_summary</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span> <span class="c1">#Reads important information of system.</span>
    <span class="c1">#KPOINTS</span>
    <span class="n">kpts</span> <span class="o">=</span> <span class="n">get_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span><span class="p">,</span><span class="n">joinPathAt</span><span class="o">=</span><span class="n">joinPathAt</span><span class="p">)</span>
    <span class="c1">#EIGENVALS</span>
    <span class="n">eigenvals</span> <span class="o">=</span> <span class="n">get_evals</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span><span class="p">,</span><span class="n">elim</span><span class="o">=</span><span class="n">elim</span><span class="p">)</span>
    <span class="c1">#TDOS</span>
    <span class="n">tot_dos</span> <span class="o">=</span> <span class="n">get_tdos</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">elim</span><span class="o">=</span><span class="n">elim</span><span class="p">)</span>
    <span class="c1">#Bands and DOS Projection</span>
    <span class="k">if</span> <span class="n">elim</span><span class="p">:</span>
        <span class="n">bands_range</span><span class="o">=</span><span class="n">eigenvals</span><span class="o">.</span><span class="n">bands_range</span>
        <span class="n">grid_range</span><span class="o">=</span><span class="n">tot_dos</span><span class="o">.</span><span class="n">grid_range</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bands_range</span><span class="o">=</span><span class="kc">None</span> <span class="c1">#projection function will read itself.</span>
        <span class="n">grid_range</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span><span class="p">(</span><span class="n">info_dic</span><span class="o">.</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">pro_bands</span> <span class="o">=</span> <span class="n">get_bands_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span><span class="p">,</span><span class="n">bands_range</span><span class="o">=</span><span class="n">bands_range</span><span class="p">,</span><span class="n">set_path</span><span class="o">=</span><span class="n">set_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pro_dos</span> <span class="o">=</span> <span class="n">get_dos_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dos_range</span><span class="o">=</span><span class="n">grid_range</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">info_dic</span><span class="o">.</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">pro_1</span> <span class="o">=</span> <span class="n">get_bands_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span><span class="p">,</span><span class="n">bands_range</span><span class="o">=</span><span class="n">bands_range</span><span class="p">,</span><span class="n">set_path</span><span class="o">=</span><span class="n">set_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pro_2</span> <span class="o">=</span> <span class="n">get_bands_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span><span class="p">,</span><span class="n">bands_range</span><span class="o">=</span><span class="n">bands_range</span><span class="p">,</span><span class="n">set_path</span><span class="o">=</span><span class="n">set_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">pros</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span> <span class="n">pro_1</span><span class="o">.</span><span class="n">pros</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span> <span class="n">pro_2</span><span class="o">.</span><span class="n">pros</span><span class="p">}</span><span class="c1">#accessing spins in dictionary after .pro.</span>
        <span class="n">pro_bands</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">pro_1</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="n">pros</span><span class="p">}</span>
        <span class="n">pdos_1</span> <span class="o">=</span> <span class="n">get_dos_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dos_range</span><span class="o">=</span><span class="n">grid_range</span><span class="p">)</span>
        <span class="n">pdos_2</span> <span class="o">=</span> <span class="n">get_dos_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dos_range</span><span class="o">=</span><span class="n">grid_range</span><span class="p">)</span>
        <span class="n">pdos</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span> <span class="n">pdos_1</span><span class="o">.</span><span class="n">pros</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span> <span class="n">pdos_2</span><span class="o">.</span><span class="n">pros</span><span class="p">}</span><span class="c1">#accessing spins in dictionary after .pro.</span>
        <span class="n">pro_dos</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">pdos_1</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="n">pdos</span><span class="p">}</span>

    <span class="c1">#Structure</span>
    <span class="n">poscar</span> <span class="o">=</span> <span class="n">get_structure</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span>
    <span class="c1">#Dimensions dictionary.</span>
    <span class="n">dim_dic</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span><span class="s1">&#39;Each of SpinUp/SpinDown Arrays&#39;</span><span class="p">,</span><span class="s1">&#39;kpoints&#39;</span><span class="p">:</span><span class="s1">&#39;(NKPTS,3)&#39;</span><span class="p">,</span><span class="s1">&#39;kpath&#39;</span><span class="p">:</span><span class="s1">&#39;(NKPTS,1)&#39;</span><span class="p">,</span><span class="s1">&#39;bands&#39;</span><span class="p">:</span><span class="s1">&#39;(NKPTS,NBANDS)&#39;</span><span class="p">,</span><span class="s1">&#39;dos&#39;</span><span class="p">:</span><span class="s1">&#39;(grid_size,3)&#39;</span><span class="p">,</span><span class="s1">&#39;pro_dos&#39;</span><span class="p">:</span><span class="s1">&#39;(NION,grid_size,en+pro_fields)&#39;</span><span class="p">,</span><span class="s1">&#39;pro_bands&#39;</span><span class="p">:</span><span class="s1">&#39;(NION,NKPTS,NBANDS,pro_fields)&#39;</span><span class="p">}</span>
    <span class="c1">#Writing everything to be accessible via dot notation</span>
    <span class="n">kpath</span><span class="o">=</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">shift_kpath</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kpts</span><span class="o">.</span><span class="n">kpath</span><span class="p">]</span>  <span class="c1"># shift kpath for side by side calculations.</span>
    <span class="n">full_dic</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sys_info&#39;</span><span class="p">:</span><span class="n">info_dic</span><span class="p">,</span><span class="s1">&#39;dim_info&#39;</span><span class="p">:</span><span class="n">dim_dic</span><span class="p">,</span><span class="s1">&#39;kpoints&#39;</span><span class="p">:</span><span class="n">kpts</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span><span class="s1">&#39;kpath&#39;</span><span class="p">:</span><span class="n">kpath</span><span class="p">,</span><span class="s1">&#39;bands&#39;</span><span class="p">:</span><span class="n">eigenvals</span><span class="p">,</span>
             <span class="s1">&#39;tdos&#39;</span><span class="p">:</span><span class="n">tot_dos</span><span class="p">,</span><span class="s1">&#39;pro_bands&#39;</span><span class="p">:</span><span class="n">pro_bands</span><span class="p">,</span><span class="s1">&#39;pro_dos&#39;</span><span class="p">:</span><span class="n">pro_dos</span><span class="p">,</span><span class="s1">&#39;poscar&#39;</span><span class="p">:</span> <span class="n">poscar</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">Dict2Data</span><span class="p">(</span><span class="n">full_dic</span><span class="p">)</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="load_export"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.load_export">[docs]</a><span class="k">def</span> <span class="nf">load_export</span><span class="p">(</span><span class="n">path</span><span class="o">=</span> <span class="s1">&#39;./vasprun.xml&#39;</span><span class="p">,</span>
                <span class="n">joinPathAt</span> <span class="o">=</span><span class="p">[],</span>
                <span class="n">shift_kpath</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">path_to_ps</span><span class="o">=</span><span class="s1">&#39;pwsh&#39;</span><span class="p">,</span>
                <span class="n">skipk</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">max_filled</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">max_empty</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">keep_files</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns a full dictionary of all objects from `vasprun.xml` file exported using powershell.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - path       : Path to `vasprun.xml` file. Default is `&#39;./vasprun.xml&#39;`.</span>
<span class="sd">        - skipk      : Default is None. Automatically detects kpoints to skip.</span>
<span class="sd">        - path_to_ps : Path to `powershell.exe`. Automatically picks on Windows and Linux if added to PATH.</span>
<span class="sd">        - joinPathAt : List of indices of kpoints where path is broken.</span>
<span class="sd">        - shift_kpath: Default 0. Can be used to merge multiple calculations side by side.</span>
<span class="sd">        - keep_files : Could be use to clean exported text files. Default is True.</span>
<span class="sd">        - max_filled : Number of filled bands below and including VBM. Default is 10.</span>
<span class="sd">        - max_empty  : Number of empty bands above VBM. Default is 10.</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - Data : Data accessible via dot notation containing nested Data objects:</span>
<span class="sd">            - sys_info  : System Information</span>
<span class="sd">            - dim_info  : Contains information about dimensions of returned objects.</span>
<span class="sd">            - kpoints   : numpy array of kpoints with excluded IBZKPT points</span>
<span class="sd">            - kpath     : 1D numpy array directly accessible for plot.</span>
<span class="sd">            - bands     : Data containing bands.</span>
<span class="sd">            - tdos      : Data containing total dos.</span>
<span class="sd">            - pro_bands : Data containing bands projections.</span>
<span class="sd">            - pro_dos   : Data containing dos projections.</span>
<span class="sd">            - poscar    : Data containing basis,positions, rec_basis and volume.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">this_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">split_path</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="c1"># abspath is important to split.</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">split_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">that_loc</span> <span class="o">=</span> <span class="n">split_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Go there.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">that_loc</span><span class="p">)</span>
    <span class="c1"># Work Here</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">required_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bands.txt&#39;</span><span class="p">,</span><span class="s1">&#39;tDOS.txt&#39;</span><span class="p">,</span><span class="s1">&#39;pDOS.txt&#39;</span><span class="p">,</span><span class="s1">&#39;Projection.txt&#39;</span><span class="p">,</span><span class="s1">&#39;SysInfo.py&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">_file</span> <span class="ow">in</span> <span class="n">required_files</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">_file</span><span class="p">)):</span>
           <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">skipk</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">gu</span><span class="o">.</span><span class="n">ps_to_std</span><span class="p">(</span><span class="n">path_to_ps</span><span class="o">=</span><span class="n">path_to_ps</span><span class="p">,</span><span class="n">ps_command</span><span class="o">=</span><span class="s1">&#39;Import-Module Vasp2Visual; Export-VR -InputFile </span><span class="si">{}</span><span class="s1"> -MaxFilled </span><span class="si">{}</span><span class="s1"> -MaxEmpty </span><span class="si">{}</span><span class="s1"> -SkipK </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">max_filled</span><span class="p">,</span><span class="n">max_empty</span><span class="p">,</span><span class="n">skipk</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gu</span><span class="o">.</span><span class="n">ps_to_std</span><span class="p">(</span><span class="n">path_to_ps</span><span class="o">=</span><span class="n">path_to_ps</span><span class="p">,</span><span class="n">ps_command</span><span class="o">=</span><span class="s1">&#39;Import-Module Vasp2Visual; Export-VR -InputFile </span><span class="si">{}</span><span class="s1"> -MaxFilled </span><span class="si">{}</span><span class="s1"> -MaxEmpty </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">max_filled</span><span class="p">,</span><span class="n">max_empty</span><span class="p">))</span>

    <span class="c1"># Enable loading SysInfo.py file as source.</span>
    <span class="n">_vars</span> <span class="o">=</span> <span class="n">SourceFileLoader</span><span class="p">(</span><span class="s2">&quot;SysInfo&quot;</span><span class="p">,</span> <span class="s2">&quot;./SysInfo.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load_module</span><span class="p">()</span>

    <span class="n">SYSTEM</span>            <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">SYSTEM</span>
    <span class="n">NKPTS</span>             <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">NKPTS</span>
    <span class="n">NBANDS</span>            <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">NBANDS</span>
    <span class="n">NFILLED</span>           <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">NFILLED</span>
    <span class="n">TypeION</span>           <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">TypeION</span>
    <span class="n">NION</span>              <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">NION</span>
    <span class="n">nField_Projection</span> <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">nField_Projection</span>
    <span class="n">E_Fermi</span>           <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">E_Fermi</span>
    <span class="n">ISPIN</span>             <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">ISPIN</span>
    <span class="n">ElemIndex</span>         <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">ElemIndex</span>
    <span class="n">ElemName</span>          <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">ElemName</span>
    <span class="n">poscar</span>            <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;volume&#39;</span><span class="p">:</span><span class="n">_vars</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                        <span class="s1">&#39;basis&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_vars</span><span class="o">.</span><span class="n">basis</span><span class="p">),</span>
                        <span class="s1">&#39;rec_basis&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_vars</span><span class="o">.</span><span class="n">rec_basis</span><span class="p">),</span>
                        <span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_vars</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
                        <span class="p">}</span>
    <span class="n">fields</span>            <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">fields</span>
    <span class="n">incar</span>             <span class="o">=</span> <span class="n">_vars</span><span class="o">.</span><span class="n">INCAR</span>
    <span class="c1"># Load Data</span>
    <span class="n">bands</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;Bands.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">NBANDS</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="c1">#Must be read in 2D even if one row only.</span>
    <span class="n">pro_bands</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;Projection.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">NBANDS</span><span class="o">*</span><span class="n">nField_Projection</span><span class="p">))</span>
    <span class="n">pro_dos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;pDOS.txt&#39;</span><span class="p">)</span>
    <span class="n">dos</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;tDOS.txt&#39;</span><span class="p">)</span>

    <span class="c1"># Keep or delete only if python generates files (i &lt; 5 case.)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">keep_files</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">i</span><span class="o">==</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">required_files</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="c1"># Return back</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">this_loc</span><span class="p">)</span>

    <span class="c1"># Work now!</span>
    <span class="n">sys_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">:</span> <span class="n">SYSTEM</span><span class="p">,</span><span class="s1">&#39;NION&#39;</span><span class="p">:</span> <span class="n">NION</span><span class="p">,</span><span class="s1">&#39;TypeION&#39;</span><span class="p">:</span> <span class="n">TypeION</span><span class="p">,</span><span class="s1">&#39;ElemName&#39;</span><span class="p">:</span> <span class="n">ElemName</span><span class="p">,</span> <span class="s1">&#39;E_Fermi&#39;</span><span class="p">:</span> <span class="n">E_Fermi</span><span class="p">,</span><span class="s1">&#39;fields&#39;</span><span class="p">:</span><span class="n">fields</span><span class="p">,</span> <span class="s1">&#39;incar&#39;</span><span class="p">:</span> <span class="n">incar</span><span class="p">,</span>
               <span class="s1">&#39;ElemIndex&#39;</span><span class="p">:</span> <span class="n">ElemIndex</span><span class="p">,</span><span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span> <span class="n">ISPIN</span><span class="p">}</span>
    <span class="n">dim_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span><span class="s1">&#39;Each of SpinUp/SpinDown Arrays&#39;</span><span class="p">,</span><span class="s1">&#39;kpoints&#39;</span><span class="p">:</span> <span class="s1">&#39;(NKPTS,3)&#39;</span><span class="p">,</span><span class="s1">&#39;kpath&#39;</span><span class="p">:</span> <span class="s1">&#39;(NKPTS,1)&#39;</span><span class="p">,</span><span class="s1">&#39;bands&#39;</span><span class="p">:</span> <span class="s1">&#39;(NKPTS,NBANDS)&#39;</span><span class="p">,</span>
<span class="s1">&#39;dos&#39;</span><span class="p">:</span> <span class="s1">&#39;(grid_size,3)&#39;</span><span class="p">,</span><span class="s1">&#39;pro_dos&#39;</span><span class="p">:</span> <span class="s1">&#39;(NION,grid_size,en+pro_fields)&#39;</span><span class="p">,</span><span class="s1">&#39;pro_bands&#39;</span><span class="p">:</span> <span class="s1">&#39;(NION,NKPTS,NBANDS,pro_fields)&#39;</span><span class="p">}</span>

    <span class="n">bands_dic</span><span class="p">,</span><span class="n">tdos_dic</span><span class="p">,</span><span class="n">pdos_dic</span><span class="p">,</span><span class="n">pro_dic</span><span class="p">,</span><span class="n">kpath</span><span class="o">=</span><span class="p">{},{},{},{},[]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">kpath</span>   <span class="o">=</span> <span class="n">bands</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">kpoints</span> <span class="o">=</span> <span class="n">bands</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">evals</span>   <span class="o">=</span> <span class="n">bands</span><span class="p">[:,</span><span class="mi">4</span><span class="p">:]</span>
        <span class="n">bands_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E_Fermi&#39;</span><span class="p">:</span> <span class="n">E_Fermi</span><span class="p">,</span> <span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span> <span class="n">ISPIN</span><span class="p">,</span> <span class="s1">&#39;NBANDS&#39;</span><span class="p">:</span> <span class="n">NBANDS</span><span class="p">,</span> <span class="s1">&#39;evals&#39;</span><span class="p">:</span> <span class="n">evals</span><span class="p">}</span>
        <span class="n">tdos_dic</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E_Fermi&#39;</span><span class="p">:</span> <span class="n">E_Fermi</span><span class="p">,</span> <span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span> <span class="n">ISPIN</span><span class="p">,</span><span class="s1">&#39;tdos&#39;</span><span class="p">:</span> <span class="n">dos</span><span class="p">}</span>
        <span class="n">pdos</span>      <span class="o">=</span> <span class="n">pro_dos</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">NION</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nField_Projection</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pdos_dic</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="n">pdos</span><span class="p">}</span>
        <span class="n">pros</span>      <span class="o">=</span> <span class="n">pro_bands</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">NION</span><span class="p">,</span><span class="n">NKPTS</span><span class="p">,</span><span class="n">NBANDS</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pro_dic</span>   <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="n">pros</span><span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
        <span class="c1"># Bands</span>
        <span class="n">kpath</span>   <span class="o">=</span> <span class="n">bands</span><span class="p">[:</span><span class="n">NKPTS</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">kpoints</span> <span class="o">=</span> <span class="n">bands</span><span class="p">[:</span><span class="n">NKPTS</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">SpinUp</span>  <span class="o">=</span> <span class="n">bands</span><span class="p">[:</span><span class="n">NKPTS</span><span class="p">,</span><span class="mi">4</span><span class="p">:]</span>
        <span class="n">SpinDown</span><span class="o">=</span> <span class="n">bands</span><span class="p">[</span><span class="n">NKPTS</span><span class="p">:,</span><span class="mi">4</span><span class="p">:]</span>
        <span class="n">evals</span>   <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">SpinUp</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span> <span class="n">SpinDown</span><span class="p">}</span>
        <span class="n">bands_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E_Fermi&#39;</span><span class="p">:</span> <span class="n">E_Fermi</span><span class="p">,</span> <span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span> <span class="n">ISPIN</span><span class="p">,</span> <span class="s1">&#39;NBANDS&#39;</span><span class="p">:</span> <span class="n">NBANDS</span><span class="p">,</span> <span class="s1">&#39;evals&#39;</span><span class="p">:</span> <span class="n">evals</span><span class="p">}</span>
        <span class="c1"># tDOS</span>
        <span class="n">dlen</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dos</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">SpinUp</span>  <span class="o">=</span> <span class="n">dos</span><span class="p">[:</span><span class="n">dlen</span><span class="p">,:]</span>
        <span class="n">SpinDown</span><span class="o">=</span> <span class="n">dos</span><span class="p">[</span><span class="n">dlen</span><span class="p">:,:]</span>
        <span class="n">tdos</span>    <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">SpinUp</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span> <span class="n">SpinDown</span><span class="p">}</span>
        <span class="n">tdos_dic</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E_Fermi&#39;</span><span class="p">:</span> <span class="n">E_Fermi</span><span class="p">,</span> <span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span> <span class="n">ISPIN</span><span class="p">,</span><span class="s1">&#39;tdos&#39;</span><span class="p">:</span> <span class="n">tdos</span><span class="p">}</span>

        <span class="c1"># pDOS</span>
        <span class="n">plen</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pro_dos</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">SpinUp</span>  <span class="o">=</span> <span class="n">pro_dos</span><span class="p">[:</span><span class="n">plen</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">NION</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nField_Projection</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">SpinDown</span><span class="o">=</span> <span class="n">pro_dos</span><span class="p">[</span><span class="n">plen</span><span class="p">:,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">NION</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nField_Projection</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pdos</span>    <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">SpinUp</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span> <span class="n">SpinDown</span><span class="p">}</span>
        <span class="n">pdos_dic</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="n">pdos</span><span class="p">}</span>

        <span class="c1"># projections</span>
        <span class="n">pblen</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pro_bands</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">SpinUp</span>  <span class="o">=</span> <span class="n">pro_bands</span><span class="p">[:</span><span class="n">pblen</span><span class="p">,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">NION</span><span class="p">,</span><span class="n">NKPTS</span><span class="p">,</span><span class="n">NBANDS</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">SpinDown</span><span class="o">=</span> <span class="n">pro_bands</span><span class="p">[</span><span class="n">pblen</span><span class="p">:,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">NION</span><span class="p">,</span><span class="n">NKPTS</span><span class="p">,</span><span class="n">NBANDS</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pros</span>    <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span> <span class="n">SpinUp</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span> <span class="n">SpinDown</span><span class="p">}</span>
        <span class="n">pro_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="n">pros</span><span class="p">}</span>
    <span class="c1"># If broken path, then join points.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">joinPathAt</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">joinPathAt</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span><span class="p">(</span><span class="n">joinPathAt</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">joinPathAt</span><span class="p">:</span>
            <span class="n">kpath</span><span class="p">[</span><span class="n">pt</span><span class="p">:]</span><span class="o">=</span><span class="n">kpath</span><span class="p">[</span><span class="n">pt</span><span class="p">:]</span><span class="o">-</span><span class="n">kpath</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span><span class="o">+</span><span class="n">kpath</span><span class="p">[</span><span class="n">pt</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">kpath</span><span class="o">=</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">shift_kpath</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kpath</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span> <span class="c1"># Shift kpath</span>
    <span class="n">full_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sys_info&#39;</span><span class="p">:</span> <span class="n">sys_info</span><span class="p">,</span><span class="s1">&#39;dim_info&#39;</span><span class="p">:</span> <span class="n">dim_info</span><span class="p">,</span><span class="s1">&#39;kpoints&#39;</span><span class="p">:</span> <span class="n">kpoints</span><span class="p">,</span><span class="s1">&#39;kpath&#39;</span><span class="p">:</span><span class="n">kpath</span><span class="p">,</span>               <span class="s1">&#39;bands&#39;</span><span class="p">:</span><span class="n">bands_dic</span><span class="p">,</span><span class="s1">&#39;tdos&#39;</span><span class="p">:</span><span class="n">tdos_dic</span><span class="p">,</span><span class="s1">&#39;pro_bands&#39;</span><span class="p">:</span> <span class="n">pro_dic</span> <span class="p">,</span><span class="s1">&#39;pro_dos&#39;</span><span class="p">:</span> <span class="n">pdos_dic</span><span class="p">,</span>
               <span class="s1">&#39;poscar&#39;</span><span class="p">:</span><span class="n">poscar</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">Dict2Data</span><span class="p">(</span><span class="n">full_dic</span><span class="p">)</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="dump_dict"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.dump_dict">[docs]</a><span class="k">def</span> <span class="nf">dump_dict</span><span class="p">(</span><span class="n">dict_data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dump_to</span> <span class="o">=</span> <span class="s1">&#39;pickle&#39;</span><span class="p">,</span><span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Dump an `export_vasprun` or `load_export`&#39;s `Data` object or any dictionary to json or pickle string/file. It convert `Dict2Data` to dictionary before serializing to json/pickle, so json/pickle.loads() of converted Data would be a simple dictionary, pass that to `Dict2Data` to again make accessible via dot notation.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - dict_data : Any dictionary/Dict2Data object containg numpy arrays, including `export_vasprun` or `load_export` output.</span>
<span class="sd">        - dump_to  : Defualt is `pickle` or `json`.</span>
<span class="sd">        - outfile  : Defualt is None and return string. File name does not require extension.</span>
<span class="sd">        - indent   : Defualt is 1. Only works for json.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dump_to</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pickle&#39;</span><span class="p">,</span><span class="s1">&#39;json&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;`dump_to` expects &#39;pickle&#39; or &#39;json&#39;, got &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dump_to</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">dict_obj</span> <span class="o">=</span> <span class="n">dict_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="c1"># Change Data object to dictionary</span>
    <span class="k">except</span><span class="p">:</span> <span class="n">dict_obj</span> <span class="o">=</span> <span class="n">dict_data</span>
    <span class="k">if</span> <span class="n">dump_to</span> <span class="o">==</span> <span class="s1">&#39;pickle&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">outfile</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dump_to</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">outfile</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">,</span><span class="bp">cls</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">EncodeFromNumpy</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dict_obj</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="bp">cls</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">EncodeFromNumpy</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="load_from_dump"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.load_from_dump">[docs]</a><span class="k">def</span> <span class="nf">load_from_dump</span><span class="p">(</span><span class="n">file_or_str</span><span class="p">,</span><span class="n">keep_as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Loads a json/pickle dumped file or string by auto detecting it.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - file_or_str : Filename of pickl/json or their string.</span>
<span class="sd">        - keep_as_dict: Defualt is False and return `Data` object. If True, returns dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_or_str</span><span class="p">,</span><span class="nb">bytes</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span> <span class="c1">#must try, else fails due to path length issue</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_or_str</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;.pickle&#39;</span> <span class="ow">in</span> <span class="n">file_or_str</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_or_str</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">elif</span> <span class="s1">&#39;.json&#39;</span> <span class="ow">in</span> <span class="n">file_or_str</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_or_str</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="bp">cls</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">DecodeToNumpy</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">out</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file_or_str</span><span class="p">,</span><span class="bp">cls</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">DecodeToNumpy</span><span class="p">)</span>
            <span class="c1"># json.loads required in else and except both as long str &gt; 260 causes issue in start of try block</span>
        <span class="k">except</span><span class="p">:</span> <span class="n">out</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file_or_str</span><span class="p">,</span><span class="bp">cls</span> <span class="o">=</span> <span class="n">gu</span><span class="o">.</span><span class="n">DecodeToNumpy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_or_str</span><span class="p">,</span><span class="nb">bytes</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file_or_str</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="n">keep_as_dict</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Dict2Data</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="islice2array"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.islice2array">[docs]</a><span class="k">def</span> <span class="nf">islice2array</span><span class="p">(</span><span class="n">path_or_islice</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span>
                <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fix_format</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">count</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">new_shape</span><span class="o">=</span><span class="kc">None</span>
                <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Reads a sliced array from txt,csv type files and return to array. Also manages if columns lengths are not equal and return 1D array. It is faster than loading  whole file into memory. This single function could be used to parse EIGENVAL, PROCAR, DOCAR and similar files with just a combination of `exclude, include,start,stop,step` arguments.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - path_or_islice: Path/to/file or `itertools.islice(file_object)`. islice is interesting when you want to read different slices of an opened file and do not want to open it again and again. For reference on how to use it just execute `pivotpy.export_potential??` in a notebook cell or ipython terminal to see how islice is used extensively.</span>
<span class="sd">        - dtype: float by default. Data type of output array, it is must have argument.</span>
<span class="sd">        - start,nlines: The indices of lines to start reading from and number of lines after start respectively. Only work if `path_or_islice` is a file path. both could be None or int, while start could be a list to read slices from file provided that nlines is int. The spacing between adjacent indices in start should be equal to or greater than nlines as pointer in file do not go back on its own.  These parameters are in output of `slice_data`</span>
<span class="sd">        &gt; Note: `start` should count comments if `exclude` is None. You can use `slice_data` function to get a dictionary of `start,nlines, count, cols, new_shape` and unpack in argument instead of thinking too much.</span>
<span class="sd">        - count: `np.size(output_array) = nrows x ncols`, if it is known before execution, performance is increased. This parameter is in output of `slice_data`.</span>
<span class="sd">        - delimiter:  Default is `\s+`. Could be any kind of delimiter valid in numpy and in the file.</span>
<span class="sd">        - cols: List of indices of columns to pick. Useful when reading a file like PROCAR which e.g. has text and numbers inline. This parameter is in output of `slice_data`.</span>
<span class="sd">        - include: Default is None and includes everything. String of patterns separated by | to keep, could be a regular expression.</span>
<span class="sd">        - exclude: Default is &#39;#&#39; to remove comments. String of patterns separated by | to drop,could be a regular expression.</span>
<span class="sd">        - raw    : Default is False, if True, returns list of raw strings. Useful to select `cols`.</span>
<span class="sd">        - fix_format: Default is True, it sepearates numbers with poor formatting like 1.000-2.000 to 1.000 2.000 which is useful in PROCAR. Keep it False if want to read string literally.</span>
<span class="sd">        - new_shape : Tuple of shape Default is None. Will try to reshape in this shape, if fails fallbacks to 2D or 1D. This parameter is in output of `slice_data`.</span>
<span class="sd">    - **Examples**</span>
<span class="sd">        &gt; `islice2array(&#39;path/to/PROCAR&#39;,start=3,include=&#39;k-point&#39;,cols=[3,4,5])[:2]`</span>
<span class="sd">        &gt; array([[ 0.125,  0.125,  0.125],</span>
<span class="sd">        &gt;        [ 0.375,  0.125,  0.125]])</span>
<span class="sd">        &gt; `islice2array(&#39;path/to/EIGENVAL&#39;,start=7,exclude=&#39;E&#39;,cols=[1,2])[:2]`</span>
<span class="sd">        &gt; array([[-11.476913,   1.      ],</span>
<span class="sd">        &gt;        [  0.283532,   1.      ]])</span>
<span class="sd">    &gt; Note: Slicing a dimension to 100% of its data is faster than let say 80% for inner dimensions, so if you have to slice more than 50% of an inner dimension, then just load full data and slice after it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nlines</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;`nlines = None` with `start = array/list` is useless combination.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="c1"># return empty array.</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_islice</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path_or_islice</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_or_islice</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">_islice</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># Read full, Will fix later.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_islice</span> <span class="o">=</span> <span class="n">path_or_islice</span>

    <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
        <span class="n">_islice</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">_islice</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">include</span><span class="p">,</span><span class="n">l</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
        <span class="n">_islice</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">_islice</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span><span class="n">l</span><span class="p">))</span>

    <span class="c1"># Make slices here after comment excluding.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nlines</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="c1">#As islice moves the pointer as it reads, start[1:]-nlines-1</span>
        <span class="c1"># This confirms spacing between two indices in start &gt;= nlines</span>
        <span class="n">start</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">*</span><span class="p">[</span><span class="n">s2</span><span class="o">-</span><span class="n">s1</span><span class="o">-</span><span class="n">nlines</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span><span class="n">s2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]]</span>
        <span class="n">_islice</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">_islice</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">s</span><span class="o">+</span><span class="n">nlines</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">start</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nlines</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="n">_islice</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">_islice</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">start</span><span class="o">+</span><span class="n">nlines</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">nlines</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="n">_islice</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">_islice</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Negative connected digits to avoid, especially in PROCAR</span>
    <span class="k">if</span> <span class="n">fix_format</span><span class="p">:</span>
        <span class="n">_islice</span> <span class="o">=</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d)-(\d)&quot;</span><span class="p">,</span><span class="sa">r</span><span class="s2">&quot;\1 -\2&quot;</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">_islice</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">_lines</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_islice</span><span class="p">)</span> <span class="c1"># join is faster than making list</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_lines</span>

    <span class="k">def</span> <span class="nf">_gen</span><span class="p">(</span><span class="n">_islice</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">_islice</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">delimiter</span><span class="p">,</span><span class="s1">&#39;  &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># if is must here.</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">chars</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">dtype</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> <span class="c1"># is must as if no data, it will raise error.</span>
            <span class="n">islice2array</span><span class="o">.</span><span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">_gen</span><span class="p">(</span><span class="n">_islice</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Do not close file before using islice</span>
    <span class="k">if</span> <span class="n">new_shape</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">islice2array</span><span class="o">.</span><span class="n">ncols</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#Otherwise single array.</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">islice2array</span><span class="o">.</span><span class="n">ncols</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="n">data</span></div>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="slice_data"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.slice_data">[docs]</a><span class="k">def</span> <span class="nf">slice_data</span><span class="p">(</span><span class="n">dim_inds</span><span class="p">,</span><span class="n">old_shape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns a dictionary that can be unpacked in arguments of isclice2array function. This function works only for regular txt/csv/tsv data files which have rectangular data written.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - dim_inds : List of indices array or range to pick from each dimension. Inner dimensions are more towards right. Last itmes in dim_inds is considered to be columns. If you want to include all values in a dimension, you can put -1 in that dimension. Note that negative indexing does not work in file readig, -1 is s special case to fetch all items.</span>
<span class="sd">        - old_shape: Shape of data set including the columns length in right most place.</span>
<span class="sd">    - **Example**</span>
<span class="sd">        - You have data as 3D arry where third dimension is along column.</span>
<span class="sd">        &gt; 0 0</span>
<span class="sd">        &gt; 0 2</span>
<span class="sd">        &gt; 1 0</span>
<span class="sd">        &gt; 1 2</span>
<span class="sd">        - To pick [[0,2], [1,2]], you need to give</span>
<span class="sd">        &gt; slice_data(dim_inds = [[0,1],[1],-1], old_shape=(2,2,2))</span>
<span class="sd">        &gt; {&#39;start&#39;: array([1, 3]), &#39;nlines&#39;: 1, &#39;count&#39;: 2}</span>
<span class="sd">        - Unpack above dictionary in `islice2array` and you will get output array.</span>
<span class="sd">    - Note that dimensions are packed from right to left, like 0,2 is repeating in 2nd column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Columns are treated diffiernetly.</span>
    <span class="k">if</span> <span class="n">dim_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dim_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">r_shape</span> <span class="o">=</span> <span class="n">old_shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dim_inds</span> <span class="o">=</span> <span class="n">dim_inds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dim_inds</span><span class="o">.</span><span class="n">copy</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">dim_inds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">nlines</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">#start = [[NIONS*NBANDS*k + NIONS*b for b in _b_r] for k in range(skipk,NKPTS)] #kind of thing.</span>
    <span class="n">_prod_</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">dim_inds</span><span class="p">)</span>
    <span class="n">_mult_</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">r_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r_shape</span><span class="p">))]</span>
    <span class="n">_out_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">_mult_</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_prod_</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># check if innermost dimensions could be chunked.</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">dim_inds</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dim_inds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1">#innermost</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">_inds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># consecutive</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_inds</span><span class="p">)</span>
            <span class="n">_out_</span> <span class="o">=</span> <span class="n">_out_</span><span class="p">[::</span><span class="n">step</span><span class="p">]</span> <span class="c1"># Pick first indices</span>
            <span class="n">nlines</span> <span class="o">=</span> <span class="n">step</span><span class="o">*</span><span class="n">nlines</span>
            <span class="c1"># Now check if all indices picked then make chunks in outer dimensions too.</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">!=</span> <span class="n">r_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="c1"># Can&#39;t make chunk of outer dimension if inner is not 100% picked.</span>
                <span class="k">break</span> <span class="c1"># Stop more chunking</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="k">for</span> <span class="n">inds</span> <span class="ow">in</span> <span class="n">dim_inds</span><span class="p">]</span> <span class="c1">#dim_inds are only in rows.</span>
    <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;start&#39;</span><span class="p">:</span><span class="n">_out_</span><span class="p">,</span><span class="s1">&#39;nlines&#39;</span><span class="p">:</span><span class="n">nlines</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">nlines</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">_out_</span><span class="p">),</span><span class="s1">&#39;cols&#39;</span><span class="p">:</span><span class="n">cols</span><span class="p">,</span><span class="s1">&#39;new_shape&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)}</span></div>


<span class="c1"># Cell</span>
<div class="viewcode-block" id="split_vasprun"><a class="viewcode-back" href="../../vr.html#pivotpy.vr_parser.split_vasprun">[docs]</a><span class="k">def</span> <span class="nf">split_vasprun</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Splits a given vasprun.xml file into a smaller _vasprun.xml file plus _set[1,2,3,4].txt files which contain projected data for each spin set.</span>
<span class="sd">    - **Parameters**</span>
<span class="sd">        - path: path/to/vasprun.xml file.</span>
<span class="sd">    - **Output**</span>
<span class="sd">        - _vasprun.xml file with projected data.</span>
<span class="sd">        - _set1.txt for projected data of colinear calculation.</span>
<span class="sd">        - _set1.txt for spin up data and _set2.txt for spin-polarized case.</span>
<span class="sd">        - _set[1,2,3,4].txt for each spin set of non-colinear calculations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./vasprun.xml&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2"> does not exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span><span class="s1">&#39;_vasprun.xml&#39;</span><span class="p">)</span>
    <span class="n">out_sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span><span class="s1">&#39;_set</span><span class="si">{}</span><span class="s1">.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)]</span>
    <span class="n">outf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="c1"># process</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;projected|/eigenvalues&#39;</span><span class="p">,</span><span class="n">l</span><span class="p">)]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">{!r}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_file</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="kc">None</span><span class="p">)))</span>
        <span class="n">outf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#projected words excluded</span>
        <span class="n">spin_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">middle</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;spin&#39;</span><span class="p">,</span><span class="n">l</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span> <span class="c1">#first useless.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spin_inds</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">set_length</span> <span class="o">=</span> <span class="n">spin_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">spin_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Must define</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">set_length</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="c1">#It is technically more than set length, but fine for 1 set</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Must be at zero</span>
        <span class="n">N_sets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spin_inds</span><span class="p">)</span>
        <span class="c1"># Let&#39;s read shape from out_file as well.</span>
        <span class="n">xml_data</span> <span class="o">=</span> <span class="n">read_asxml</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
        <span class="n">_summary</span> <span class="o">=</span> <span class="n">get_summary</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span>
        <span class="n">NIONS</span>  <span class="o">=</span> <span class="n">_summary</span><span class="o">.</span><span class="n">NION</span>
        <span class="n">NORBS</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_summary</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">NBANDS</span> <span class="o">=</span> <span class="n">get_evals</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span><span class="o">.</span><span class="n">NBANDS</span>
        <span class="n">NKPTS</span>  <span class="o">=</span> <span class="n">get_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span><span class="o">.</span><span class="n">NKPTS</span>
        <span class="k">del</span> <span class="n">xml_data</span> <span class="c1"># free meory now.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_sets</span><span class="p">):</span> <span class="c1">#Reads every set</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">{!r}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_sets</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">spin_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># pointer is there next time.</span>
            <span class="n">stop_</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">set_length</span> <span class="c1"># Should move up to set length only.</span>
            <span class="n">setf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_sets</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">setf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  # Set: </span><span class="si">{}</span><span class="s2"> Shape: (NKPTS[NBANDS[NIONS]],NORBS) = </span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">NKPTS</span><span class="p">,</span><span class="n">NBANDS</span><span class="p">,</span><span class="n">NIONS</span><span class="p">,</span><span class="n">NORBS</span><span class="p">))</span>
            <span class="n">middle</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">stop_</span><span class="p">)</span>
            <span class="n">setf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;r&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">middle</span> <span class="k">if</span> <span class="s1">&#39;&lt;/r&gt;&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">))</span>
            <span class="n">setf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
        <span class="n">outf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Abdul Saboor

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>